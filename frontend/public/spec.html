<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lab Report AI Specification</title>
  <style>
    /* ========================================
       LabReportAI Specification - Professional Stylesheet
       ======================================== */

    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #dbeafe;
      --secondary: #7c3aed;
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }

    * {
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.7;
      color: var(--gray-800);
      background: var(--gray-50);
      margin: 0;
      padding: 0;
    }

    /* ========================================
       Layout - Desktop with Sidebar TOC
       ======================================== */

    @media (min-width: 1100px) {
      body {
        display: grid;
        grid-template-columns: 280px 1fr;
        grid-template-rows: auto 1fr;
        min-height: 100vh;
      }

      header#title-block-header {
        grid-column: 1 / -1;
        grid-row: 1;
      }

      nav#TOC {
        grid-column: 1;
        grid-row: 2;
        position: sticky;
        top: 0;
        height: calc(100vh);
        overflow-y: auto;
        background: var(--gray-900);
        padding: 1.5rem 1rem;
        border-right: 1px solid var(--gray-700);
      }

      .main-content {
        grid-column: 2;
        grid-row: 2;
        max-width: 900px;
        padding: 2rem 3rem;
      }
    }

    /* Mobile Layout */
    @media (max-width: 1099px) {
      nav#TOC {
        background: var(--gray-100);
        padding: 1.5rem;
        margin: 1rem;
        border-radius: 8px;
        border: 1px solid var(--gray-200);
      }

      .main-content {
        max-width: 900px;
        margin: 0 auto;
        padding: 1rem 1.5rem;
      }
    }

    /* ========================================
       Header
       ======================================== */

    header#title-block-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 2.5rem 2rem;
      margin: 0;
      text-align: center;
    }

    header h1.title {
      margin: 0;
      font-size: 2.25rem;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0,0,0,0.15);
      border: none;
      color: white;
    }

    /* ========================================
       Table of Contents
       ======================================== */

    nav#TOC::before {
      content: 'Contents';
      display: block;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #93c5fd;
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid rgba(147, 197, 253, 0.3);
    }

    @media (max-width: 1099px) {
      nav#TOC::before {
        color: var(--gray-600);
        border-bottom-color: var(--gray-300);
      }
    }

    nav#TOC ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    nav#TOC > ul > li {
      margin-bottom: 0.25rem;
    }

    nav#TOC ul ul {
      padding-left: 0.875rem;
      margin-top: 0.25rem;
      border-left: 2px solid rgba(255, 255, 255, 0.15);
      margin-left: 0.5rem;
    }

    nav#TOC ul ul a {
      color: #b4bcd0;
      font-size: 0.8rem;
    }

    nav#TOC ul ul a:hover {
      color: #ffffff;
    }

    @media (max-width: 1099px) {
      nav#TOC ul ul {
        border-left-color: var(--gray-300);
      }
    }

    nav#TOC a {
      color: #d1d5db;
      text-decoration: none;
      font-size: 0.8125rem;
      display: block;
      padding: 0.375rem 0.625rem;
      border-radius: 4px;
      transition: all 0.15s ease;
      line-height: 1.5;
    }

    nav#TOC a:hover {
      color: #ffffff;
      background: rgba(255, 255, 255, 0.1);
    }

    nav#TOC > ul > li > a {
      font-weight: 600;
      color: #f3f4f6;
      font-size: 0.875rem;
      padding: 0.5rem 0.625rem;
      margin-bottom: 0.125rem;
    }

    @media (max-width: 1099px) {
      nav#TOC a {
        color: var(--gray-600);
      }
      nav#TOC a:hover {
        color: var(--primary);
        background: var(--primary-light);
      }
      nav#TOC > ul > li > a {
        color: var(--gray-800);
      }
    }

    /* ========================================
       Typography - Headings
       ======================================== */

    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
      line-height: 1.3;
      margin-top: 2.5rem;
      margin-bottom: 1rem;
    }

    h1 {
      font-size: 1.875rem;
      color: var(--gray-900);
      padding-bottom: 0.5rem;
      border-bottom: 3px solid var(--primary);
      margin-top: 0;
    }

    h2 {
      font-size: 1.5rem;
      color: var(--primary-dark);
      padding-bottom: 0.375rem;
      border-bottom: 2px solid var(--gray-200);
    }

    h3 {
      font-size: 1.25rem;
      color: var(--gray-700);
    }

    h4 {
      font-size: 1.1rem;
      color: var(--gray-600);
    }

    h5, h6 {
      font-size: 1rem;
      color: var(--gray-600);
    }

    /* ========================================
       Tables
       ======================================== */

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;
      font-size: 0.875rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.12);
      border-radius: 8px;
      overflow: hidden;
      background: white;
    }

    thead {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    thead th {
      padding: 0.75rem 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    tbody tr {
      border-bottom: 1px solid var(--gray-100);
      transition: background 0.15s ease;
    }

    tbody tr:nth-child(even) {
      background: var(--gray-50);
    }

    tbody tr:hover {
      background: var(--primary-light);
    }

    tbody td {
      padding: 0.625rem 1rem;
      vertical-align: top;
    }

    tbody td:first-child {
      font-weight: 500;
      color: var(--gray-700);
    }

    /* ========================================
       Code Blocks
       ======================================== */

    pre {
      background: var(--gray-900);
      color: #e5e7eb;
      padding: 1.25rem;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 0.8125rem;
      line-height: 1.6;
      margin: 1.5rem 0;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    pre code {
      background: none;
      padding: 0;
      color: inherit;
      font-size: inherit;
    }

    code {
      background: var(--gray-100);
      color: var(--secondary);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-size: 0.85em;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', Consolas, 'Liberation Mono', monospace;
    }

    /* Syntax Highlighting */
    code span.kw { color: #c792ea; font-weight: 600; }
    code span.dt { color: #ffcb6b; }
    code span.st { color: #c3e88d; }
    code span.co { color: #546e7a; font-style: italic; }
    code span.fu { color: #82aaff; }
    code span.dv { color: #f78c6c; }
    code span.cf { color: #c792ea; }
    code span.op { color: #89ddff; }
    code span.ch { color: #c3e88d; }
    code span.bn { color: #f78c6c; }
    code span.fl { color: #f78c6c; }
    code span.va { color: #f07178; }
    code span.cn { color: #f78c6c; }
    code span.im { color: #c792ea; }
    code span.at { color: #ffcb6b; }

    .sourceCode { overflow: visible; }
    div.sourceCode { margin: 1em 0; }

    /* ========================================
       Links
       ======================================== */

    a {
      color: var(--primary);
      text-decoration: none;
      transition: color 0.15s ease;
    }

    a:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    /* ========================================
       Lists
       ======================================== */

    ul, ol {
      margin: 1rem 0;
      padding-left: 1.5rem;
    }

    li {
      margin-bottom: 0.375rem;
    }

    li > ul, li > ol {
      margin-top: 0.375rem;
      margin-bottom: 0;
    }

    /* Task Lists */
    ul.task-list {
      list-style: none;
      padding-left: 0;
    }

    ul.task-list li {
      position: relative;
      padding-left: 1.75rem;
    }

    ul.task-list input[type="checkbox"] {
      position: absolute;
      left: 0;
      top: 0.25rem;
      width: 1rem;
      height: 1rem;
      accent-color: var(--success);
    }

    /* ========================================
       Blockquotes
       ======================================== */

    blockquote {
      border-left: 4px solid var(--primary);
      background: var(--primary-light);
      margin: 1.5rem 0;
      padding: 1rem 1.25rem;
      border-radius: 0 8px 8px 0;
      color: var(--gray-700);
    }

    blockquote p {
      margin: 0;
    }

    blockquote p + p {
      margin-top: 0.75rem;
    }

    /* ========================================
       Horizontal Rules
       ======================================== */

    hr {
      border: none;
      height: 2px;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--primary));
      margin: 3rem 0;
      border-radius: 1px;
    }

    /* ========================================
       Paragraphs & Text
       ======================================== */

    p {
      margin: 1rem 0;
    }

    strong {
      color: var(--gray-900);
      font-weight: 600;
    }

    em {
      font-style: italic;
    }

    /* ========================================
       Definition Lists
       ======================================== */

    dl {
      margin: 1rem 0;
    }

    dt {
      font-weight: 600;
      color: var(--gray-800);
      margin-top: 1rem;
    }

    dd {
      margin-left: 1.5rem;
      color: var(--gray-600);
    }

    /* ========================================
       Images
       ======================================== */

    img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* ========================================
       Scrollbar (WebKit)
       ======================================== */

    nav#TOC::-webkit-scrollbar {
      width: 6px;
    }

    nav#TOC::-webkit-scrollbar-track {
      background: var(--gray-800);
    }

    nav#TOC::-webkit-scrollbar-thumb {
      background: var(--gray-600);
      border-radius: 3px;
    }

    nav#TOC::-webkit-scrollbar-thumb:hover {
      background: var(--gray-500);
    }

    /* ========================================
       Print Styles
       ======================================== */

    @media print {
      nav#TOC {
        display: none;
      }

      body {
        display: block;
        background: white;
      }

      header#title-block-header {
        background: var(--primary) !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        background: var(--gray-100) !important;
        color: var(--gray-900) !important;
      }

      table {
        page-break-inside: avoid;
      }

      h2, h3 {
        page-break-after: avoid;
      }
    }

    /* ========================================
       Pandoc-specific overrides
       ======================================== */

    .display.math {
      display: block;
      text-align: center;
      margin: 0.5rem auto;
    }

    span.smallcaps {
      font-variant: small-caps;
    }

    span.underline {
      text-decoration: underline;
    }

    div.column {
      display: inline-block;
      vertical-align: top;
      width: 50%;
    }

    div.hanging-indent {
      margin-left: 1.5em;
      text-indent: -1.5em;
    }
  </style>
</head>
<body>
<header id="title-block-header">
  <h1 class="title">Lab Report AI Specification</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#lab-report-ai-interpretation-api-comprehensive-specification-v2.1">Lab Report AI Interpretation API â€“ Comprehensive Specification (v2.1)</a>
<ul>
<li><a href="#intent">1. Intent</a></li>
<li><a href="#architecture-tech-stack">2. Architecture &amp; Tech Stack</a>
<ul>
<li><a href="#architecture-overview">Architecture Overview</a></li>
<li><a href="#tech-stack">Tech Stack</a></li>
</ul></li>
<li><a href="#success-criteria">3. Success Criteria</a></li>
<li><a href="#inputs-outputs-interfaces">4. Inputs / Outputs / Interfaces</a>
<ul>
<li><a href="#inputs">Inputs</a></li>
<li><a href="#outputs">Outputs</a></li>
<li><a href="#api-endpoints">API Endpoints</a></li>
<li><a href="#interfaces">Interfaces</a></li>
</ul></li>
<li><a href="#workflow-logic">5. Workflow / Logic</a>
<ul>
<li><a href="#website-flow">Website Flow</a></li>
<li><a href="#whatsapp-flow-twilio">WhatsApp Flow (Twilio)</a></li>
<li><a href="#edge-cases-exceptions">Edge Cases / Exceptions</a></li>
</ul></li>
<li><a href="#output-format">6. Output Format</a>
<ul>
<li><a href="#interpretation-sections-ordered">Interpretation Sections (ordered)</a></li>
<li><a href="#color-coding-hybrid">Color Coding (Hybrid)</a></li>
<li><a href="#charts">Charts</a></li>
<li><a href="#pdf-layout">PDF Layout</a></li>
<li><a href="#reference-ranges">Reference Ranges</a></li>
<li><a href="#translation-v1">Translation (v1)</a></li>
<li><a href="#mandatory-disclaimer">Mandatory Disclaimer</a></li>
</ul></li>
<li><a href="#configuration-options">7. Configuration Options</a></li>
<li><a href="#safety-security-privacy">8. Safety, Security &amp; Privacy</a>
<ul>
<li><a href="#pii-sanitization">PII Sanitization</a></li>
<li><a href="#security-measures">Security Measures</a></li>
</ul></li>
<li><a href="#database-schema">9. Database Schema</a>
<ul>
<li><a href="#mysql-reports-table-v1">MySQL â€” <code>reports</code> Table (v1)</a></li>
<li><a href="#redis-keys">Redis Keys</a></li>
</ul></li>
<li><a href="#acceptance-criteria-test-scenarios">10. Acceptance Criteria / Test Scenarios</a></li>
<li><a href="#project-structure">11. Project Structure</a></li>
<li><a href="#implementation-plan-7-phases">12. Implementation Plan (7 Phases)</a>
<ul>
<li><a href="#phase-1-foundation-infrastructure">Phase 1: Foundation &amp; Infrastructure</a></li>
<li><a href="#phase-2-ocr-pii-scrubbing-pre-validation">Phase 2: OCR, PII Scrubbing &amp; Pre-Validation</a></li>
<li><a href="#phase-3-llm-analysis-core-intelligence">Phase 3: LLM Analysis (Core Intelligence)</a></li>
<li><a href="#phase-4-charts-pdf-generation">Phase 4: Charts &amp; PDF Generation</a></li>
<li><a href="#phase-5-security-rate-limiting-file-cleanup">Phase 5: Security, Rate Limiting &amp; File Cleanup</a></li>
<li><a href="#phase-6-translation-whatsapp-integration">Phase 6: Translation &amp; WhatsApp Integration</a></li>
<li><a href="#phase-7-e2e-testing-polish-production-readiness">Phase 7: E2E Testing, Polish &amp; Production Readiness</a></li>
</ul></li>
<li><a href="#phase-dependency-chain">13. Phase Dependency Chain</a></li>
<li><a href="#future-considerations-post-v1">14. Future Considerations (Post-v1)</a></li>
<li><a href="#production-deployment">15. Production Deployment</a>
<ul>
<li><a href="#production-architecture">Production Architecture</a></li>
<li><a href="#hosting-oracle-cloud-always-free-tier">Hosting: Oracle Cloud Always-Free Tier</a></li>
<li><a href="#domain-ssl">Domain &amp; SSL</a></li>
<li><a href="#production-service-configuration">Production Service Configuration</a></li>
<li><a href="#deployment-files">Deployment Files</a></li>
<li><a href="#deployment-steps">Deployment Steps</a></li>
<li><a href="#production-commands">Production Commands</a></li>
<li><a href="#security-checklist">Security Checklist</a></li>
<li><a href="#cost-summary">Cost Summary</a></li>
</ul></li>
<li><a href="#detailed-deployment-guide">16. Detailed Deployment Guide</a>
<ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#step-1-server-initial-setup-one-time">Step 1: Server Initial Setup (One-time)</a></li>
<li><a href="#step-2-build-frontend-image-windows">Step 2: Build Frontend Image (Windows)</a></li>
<li><a href="#step-3-deploy-on-server">Step 3: Deploy on Server</a></li>
<li><a href="#step-4-verify-deployment">Step 4: Verify Deployment</a></li>
<li><a href="#redeployment-after-code-changes">Redeployment (After Code Changes)</a></li>
</ul></li>
<li><a href="#known-issues-fixes">17. Known Issues &amp; Fixes</a>
<ul>
<li><a href="#react-hydration-error-418">React Hydration Error #418</a></li>
<li><a href="#docker-volume-override-issue">Docker Volume Override Issue</a></li>
<li><a href="#caddy-ssl-certificate-timeout">Caddy SSL Certificate Timeout</a></li>
</ul></li>
<li><a href="#post-analysis-chat-feature-phase-8">18. Post-Analysis Chat Feature (Phase 8)</a>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#user-experience">User Experience</a></li>
<li><a href="#starter-questions-initial-suggestions">Starter Questions (Initial Suggestions)</a></li>
<li><a href="#contextual-follow-up-suggestions">Contextual Follow-up Suggestions</a></li>
<li><a href="#api-specification">API Specification</a></li>
<li><a href="#backend-implementation">Backend Implementation</a></li>
<li><a href="#frontend-implementation">Frontend Implementation</a></li>
<li><a href="#configuration-options-1">Configuration Options</a></li>
<li><a href="#database-changes">Database Changes</a></li>
<li><a href="#files-to-createmodify">Files to Create/Modify</a></li>
<li><a href="#acceptance-criteria">Acceptance Criteria</a></li>
<li><a href="#out-of-scope-future-enhancements">Out of Scope (Future Enhancements)</a></li>
</ul></li>
<li><a href="#medical-imaging-analysis-future---phase-9">19. Medical Imaging Analysis (Future - Phase 9)</a>
<ul>
<li><a href="#overview-1">Overview</a></li>
<li><a href="#architecture-approach">Architecture Approach</a></li>
<li><a href="#scope-decisions">Scope Decisions</a></li>
<li><a href="#new-files-to-create">New Files to Create</a></li>
<li><a href="#files-to-modify">Files to Modify</a></li>
<li><a href="#database-migration">Database Migration</a></li>
<li><a href="#configuration-.env">Configuration (.env)</a></li>
<li><a href="#output-structure-for-imaging">Output Structure for Imaging</a></li>
<li><a href="#cost-estimation-per-image">Cost Estimation (Per Image)</a></li>
<li><a href="#implementation-sequence">Implementation Sequence</a></li>
<li><a href="#future-dicom-support-phase-10">Future: DICOM Support (Phase 10)</a></li>
</ul></li>
<li><a href="#website-branding-ui">20. Website Branding &amp; UI</a>
<ul>
<li><a href="#header">Header</a></li>
<li><a href="#footer">Footer</a></li>
<li><a href="#favicon">Favicon</a></li>
<li><a href="#action-button-animation">Action Button Animation</a></li>
<li><a href="#files">Files</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<div class="main-content">
<h1 id="lab-report-ai-interpretation-api-comprehensive-specification-v2.1">Lab Report AI Interpretation API â€“ Comprehensive Specification (v2.1)</h1>
<hr />
<h2 id="intent">1. Intent</h2>
<p>The <strong>Lab Report AI Interpretation API</strong> is a full-stack system designed to: - Interpret clinical lab reports (blood, urine, stool, and standard clinical tests) for <strong>educational insights</strong>, <strong>not diagnosis</strong>. - Provide structured outputs in Markdown and PDF with visual indicators (Red/Yellow/Green) and bar + gauge charts for abnormal or critical values. - Support multi-language output (English + Urdu for v1) while <strong>preserving medical terms</strong> in parenthetical English. - Ensure privacy via <strong>PII sanitization</strong> (all personal info scrubbed) and temporary storage (24â€“48 hours). - Support <strong>Website</strong> uploads (Next.js) and <strong>WhatsApp</strong> chat interface (Twilio). - Provide reference range sourcing (extracted from report; fallback to LLM medical knowledge with explicit note).</p>
<p><strong>Non-Goals / Out-of-Scope:</strong> - No medical diagnosis or treatment recommendation. - No mobile app (v1). - No multi-language input reports (English only). - No EHR/EMR integration. - No permanent data storage beyond retention period. - No user accounts or authentication (v1) â€” reCAPTCHA only. - No CI/CD pipeline (deferred to later stages). - No advanced analytics beyond WhatsApp trends.</p>
<hr />
<h2 id="architecture-tech-stack">2. Architecture &amp; Tech Stack</h2>
<h3 id="architecture-overview">Architecture Overview</h3>
<ul>
<li><strong>Monorepo</strong> structure: <code>/frontend</code> (Next.js) and <code>/backend</code> (FastAPI) in a single repository.</li>
<li><strong>Async processing</strong> via Celery workers â€” upload returns a <code>job_id</code>, frontend polls for status.</li>
<li><strong>Docker Compose</strong> orchestrates all services.</li>
</ul>
<h3 id="tech-stack">Tech Stack</h3>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 40%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Layer</th>
<th>Technology</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Frontend</td>
<td>Next.js (React)</td>
<td>Website UI</td>
</tr>
<tr class="even">
<td>UI Components</td>
<td>Tailwind CSS + shadcn/ui</td>
<td>Styling and component library</td>
</tr>
<tr class="odd">
<td>Bot Protection</td>
<td>Google reCAPTCHA v3</td>
<td>Invisible CAPTCHA on website</td>
</tr>
<tr class="even">
<td>Backend API</td>
<td>FastAPI</td>
<td>REST API</td>
</tr>
<tr class="odd">
<td>Async Tasks</td>
<td>Celery + Redis</td>
<td>Background report processing</td>
</tr>
<tr class="even">
<td>LLM Framework</td>
<td>LangChain</td>
<td>LLM orchestration (prompts, chains, output parsing)</td>
</tr>
<tr class="odd">
<td>LLM Analysis</td>
<td>GPT-4o (configurable)</td>
<td>Main report interpretation</td>
</tr>
<tr class="even">
<td>LLM Validation</td>
<td>GPT-4o-mini (configurable)</td>
<td>Pre-validation (is it a lab report?)</td>
</tr>
<tr class="odd">
<td>OCR</td>
<td>PaddleOCR</td>
<td>Text extraction from images/PDFs</td>
</tr>
<tr class="even">
<td>PDF Generation</td>
<td>WeasyPrint</td>
<td>HTML-to-PDF conversion</td>
</tr>
<tr class="odd">
<td>Charts</td>
<td>Matplotlib</td>
<td>Bar charts + gauge charts</td>
</tr>
<tr class="even">
<td>Database</td>
<td>MySQL (SQLAlchemy + Alembic)</td>
<td>Report records persistence</td>
</tr>
<tr class="odd">
<td>Cache/Broker</td>
<td>Redis</td>
<td>Celery broker + WhatsApp session state</td>
</tr>
<tr class="even">
<td>WhatsApp</td>
<td>Twilio WhatsApp Business API</td>
<td>Chat interface</td>
</tr>
<tr class="odd">
<td>Deployment</td>
<td>Docker Compose</td>
<td>Container orchestration</td>
</tr>
<tr class="even">
<td>File Storage</td>
<td>Docker Volume</td>
<td>Uploaded files + generated PDFs</td>
</tr>
<tr class="odd">
<td>Logging</td>
<td>Python standard logging</td>
<td>Application logging</td>
</tr>
<tr class="even">
<td>Prompts</td>
<td>Separate <code>.txt</code> files in <code>/prompts</code></td>
<td>LLM prompt templates</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="success-criteria">3. Success Criteria</h2>
<ul>
<li><strong>Functional:</strong>
<ul>
<li>Reports analyzed and returned in Markdown + PDF with all 7 output sections.</li>
<li>Bar + gauge charts generated for abnormal/critical values.</li>
<li>Reference ranges clearly identified with source noted.</li>
<li>WhatsApp bot collects age/gender before processing report.</li>
</ul></li>
<li><strong>Performance:</strong>
<ul>
<li>Response time: 5â€“15 seconds per report.</li>
<li>Handles concurrent uploads without failure.</li>
<li>Polling-based async â€” instant job acknowledgment.</li>
</ul></li>
<li><strong>Safety / Accuracy:</strong>
<ul>
<li>Mandatory disclaimers on all outputs.</li>
<li>Color coding (green/yellow/red) reflects LLM severity + rule-based mapping.</li>
<li>Urdu translation preserves medical terms in parenthetical English.</li>
</ul></li>
<li><strong>Configurability:</strong>
<ul>
<li>File limits, page limits, LLM models, OCR engine, retention period, rate limits, and validation thresholds adjustable via environment variables.</li>
</ul></li>
</ul>
<hr />
<h2 id="inputs-outputs-interfaces">4. Inputs / Outputs / Interfaces</h2>
<h3 id="inputs">Inputs</h3>
<table style="width:100%;">
<colgroup>
<col style="width: 35%" />
<col style="width: 30%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr class="header">
<th>Field</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>user_id</code></td>
<td>string</td>
<td>Unique session identifier; tracks WhatsApp flow</td>
</tr>
<tr class="even">
<td><code>age</code></td>
<td>integer</td>
<td>Patient age; mandatory for WhatsApp, optional for website</td>
</tr>
<tr class="odd">
<td><code>gender</code></td>
<td>string</td>
<td>Male / Female / Other; mandatory for WhatsApp, optional for website</td>
</tr>
<tr class="even">
<td><code>language</code></td>
<td>string</td>
<td>ISO code: <code>en</code> or <code>ur</code> (v1); defaults to <code>en</code></td>
</tr>
<tr class="odd">
<td><code>file</code></td>
<td>file (multipart)</td>
<td>Uploaded report (PDF/JPG/PNG) â€” website uses multipart upload</td>
</tr>
<tr class="even">
<td><code>file_type</code></td>
<td>string</td>
<td>MIME type: <code>application/pdf</code>, <code>image/jpeg</code>, <code>image/png</code></td>
</tr>
<tr class="odd">
<td><code>captcha_token</code></td>
<td>string</td>
<td>Google reCAPTCHA v3 token (website only)</td>
</tr>
</tbody>
</table>
<h3 id="outputs">Outputs</h3>
<table>
<colgroup>
<col style="width: 38%" />
<col style="width: 28%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Output</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Markdown</td>
<td>string</td>
<td>Full 7-section interpretation with color indicators</td>
</tr>
<tr class="even">
<td>PDF</td>
<td>file</td>
<td>Includes bar + gauge charts, color-coded tables (WeasyPrint)</td>
</tr>
<tr class="odd">
<td>Charts</td>
<td>image</td>
<td>Bar charts + gauge charts via Matplotlib, embedded in PDF</td>
</tr>
<tr class="even">
<td>Error</td>
<td>JSON</td>
<td>Standardized: <code>{ "status": "error", "code": int, "message": str }</code></td>
</tr>
</tbody>
</table>
<h3 id="api-endpoints">API Endpoints</h3>
<table>
<colgroup>
<col style="width: 29%" />
<col style="width: 37%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Endpoint</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>POST</td>
<td><code>/v1/analyze-report</code></td>
<td>Submit report; returns <code>{ "job_id": "..." }</code></td>
</tr>
<tr class="even">
<td>GET</td>
<td><code>/v1/status/{job_id}</code></td>
<td>Poll status; returns status, markdown, pdf_url, error</td>
</tr>
<tr class="odd">
<td>GET</td>
<td><code>/v1/download/{job_id}</code></td>
<td>Download generated PDF</td>
</tr>
<tr class="even">
<td>POST</td>
<td><code>/v1/whatsapp/webhook</code></td>
<td>Twilio WhatsApp incoming webhook</td>
</tr>
<tr class="odd">
<td>GET</td>
<td><code>/v1/health</code></td>
<td>Health check for all services</td>
</tr>
</tbody>
</table>
<h3 id="interfaces">Interfaces</h3>
<ul>
<li><strong>Website:</strong> Next.js upload form (file, age, gender, language selector) with reCAPTCHA v3. Polling-based loading UX with spinner â€” â€œYour report is being processed.â€ Results rendered as formatted markdown with PDF download button.</li>
<li><strong>WhatsApp:</strong> Twilio webhook. Bot sends brief text message (â€œYour report is readyâ€) + PDF attachment. No raw markdown over WhatsApp.</li>
<li><strong>Storage:</strong> Docker volume for uploaded files and generated PDFs. Auto-deleted after 24â€“48 hours.</li>
</ul>
<hr />
<h2 id="workflow-logic">5. Workflow / Logic</h2>
<h3 id="website-flow">Website Flow</h3>
<ol type="1">
<li>User enters age/gender (optional), selects language, uploads report file. reCAPTCHA v3 validates.</li>
<li>System validates file type, size (â‰¤20 MB), and page count (â‰¤30 pages).</li>
<li>Backend saves file, creates DB record, dispatches Celery task, returns <code>job_id</code>.</li>
<li>Frontend redirects to results page, polls <code>GET /v1/status/{job_id}</code> every 2â€“3 seconds with loading spinner.</li>
<li><strong>Celery task pipeline:</strong>
<ol type="a">
<li>OCR extraction (PaddleOCR) â€” extract text from image/PDF.</li>
<li>Pre-validation â€” cheap LLM (GPT-4o-mini) confirms extracted text is a lab report.</li>
<li>PII scrubbing â€” remove all personal info from OCR text.</li>
<li>LLM analysis â€” GPT-4o interprets scrubbed text (English), returns structured JSON.</li>
<li>Translation â€” if language â‰  English, translate via LLM (medical terms preserved with English in parentheses).</li>
<li>Chart generation â€” Matplotlib creates bar + gauge charts for abnormal/critical values.</li>
<li>PDF generation â€” WeasyPrint renders HTML template with charts and color-coded tables.</li>
</ol></li>
<li>Frontend detects completion, renders markdown interpretation, shows PDF download button.</li>
<li>Error handling: invalid file, unreadable scan, unsupported lab, LLM failure â€” all return user-friendly messages.</li>
</ol>
<h3 id="whatsapp-flow-twilio">WhatsApp Flow (Twilio)</h3>
<ol type="1">
<li>Bot prompts sequentially: Age â†’ Gender â†’ Report upload.</li>
<li>Redis state machine per phone number: <code>AWAITING_AGE</code> â†’ <code>AWAITING_GENDER</code> â†’ <code>AWAITING_REPORT</code> â†’ <code>PROCESSING</code>.</li>
<li>System validates file, runs same Celery pipeline as website.</li>
<li>On completion, bot sends brief text message + PDF attachment via Twilio.</li>
<li>Incomplete sessions auto-expire after 30 minutes (Redis TTL).</li>
<li>Handle edge cases: invalid age/gender input (retry prompt), blurred images, unsupported labs.</li>
</ol>
<h3 id="edge-cases-exceptions">Edge Cases / Exceptions</h3>
<ul>
<li><strong>Blurred / low-quality images:</strong> Attempt OCR â†’ detect garbage text via heuristic â†’ reject with re-upload message.</li>
<li><strong>Unsupported/excessively long reports:</strong> Enforce file size and page limits.</li>
<li><strong>Non-English input:</strong> Reports must be English; translation applied only to output.</li>
<li><strong>Non-lab documents:</strong> Pre-validation rejects with â€œThis does not appear to be a lab report.â€</li>
<li><strong>LLM failure:</strong> Retry once; on second failure, return error message.</li>
<li><strong>Chart/PDF failure:</strong> Still return markdown (graceful degradation); log warning.</li>
</ul>
<hr />
<h2 id="output-format">6. Output Format</h2>
<h3 id="interpretation-sections-ordered">Interpretation Sections (ordered)</h3>
<ol type="1">
<li><strong>Patient Info</strong> â€” Age, gender (if provided), report date</li>
<li><strong>Summary</strong> â€” 2â€“3 sentence high-level overview of findings</li>
<li><strong>Category-wise Results</strong> â€” Grouped by: CBC, Liver Panel, Kidney Panel, Thyroid, Lipid Profile, etc. Each test shows: name, value, unit, reference range, source, severity</li>
<li><strong>Abnormal Values Analysis</strong> â€” Detailed explanation of out-of-range values</li>
<li><strong>Clinical Associations</strong> â€” Educational associations (not diagnostic)</li>
<li><strong>Lifestyle Tips</strong> â€” General wellness recommendations related to findings</li>
<li><strong>Disclaimer</strong> â€” Mandatory on every output</li>
</ol>
<h3 id="color-coding-hybrid">Color Coding (Hybrid)</h3>
<p>LLM assigns severity categories per test value. System applies consistent color mapping: - ğŸŸ¢ <strong>Green (Normal)</strong> â€” Within reference range - ğŸŸ¡ <strong>Yellow (Borderline)</strong> â€” Slightly outside reference range - ğŸ”´ <strong>Red (Critical)</strong> â€” Significantly abnormal</p>
<p><strong>Severity indicators in markdown:</strong> Use emoji circles (ğŸŸ¢ ğŸŸ¡ ğŸ”´) for universal rendering in markdown, web, and terminals. Frontend renders backend-generated markdown via <code>react-markdown</code> (not custom React components from JSON).</p>
<h3 id="charts">Charts</h3>
<ul>
<li><strong>Bar charts</strong> â€” Horizontal bars per test category. Each test value vs.Â reference range. Color-coded green/yellow/red. Only generated for numeric test values (string values like â€œPositiveâ€ are skipped).</li>
<li><strong>Gauge charts</strong> â€” Speedometer-style for both <strong>critical and borderline</strong> values. Shows where patientâ€™s value falls within the overall range. Only for numeric values.</li>
<li><strong>Placement in PDF</strong> â€” Charts placed inline after each category table (bar chart â†’ gauge charts for that categoryâ€™s abnormal values).</li>
</ul>
<h3 id="pdf-layout">PDF Layout</h3>
<ul>
<li><strong>Header</strong> on each page: â€œLab Report AI - Analysis Reportâ€</li>
<li><strong>Footer</strong> on each page: page number + brief disclaimer note</li>
<li>Professional, clean layout with color-coded table rows</li>
</ul>
<h3 id="reference-ranges">Reference Ranges</h3>
<ul>
<li>LLM extracts reference ranges from the lab report text.</li>
<li>If not present on the report, LLM uses its medical knowledge and the output explicitly states: <em>â€œReference values not available in the report; ranges based on standard medical knowledge.â€</em></li>
</ul>
<h3 id="translation-v1">Translation (v1)</h3>
<ul>
<li><strong>Languages:</strong> English + Urdu</li>
<li><strong>Medical terms:</strong> Translated to target language with English in parentheses.
<ul>
<li>Example: ÛÛŒÙ…ÙˆÚ¯Ù„ÙˆØ¨Ù† (Hemoglobin) Ú©ÛŒ Ø³Ø·Ø­ Ù†Ø§Ø±Ù…Ù„ ÛÛ’Û”</li>
</ul></li>
<li><strong>RTL support</strong> in PDF output for Urdu.</li>
</ul>
<h3 id="mandatory-disclaimer">Mandatory Disclaimer</h3>
<blockquote>
<p>â€œThis report provides educational insights and clinical associations only. It is not a diagnosis or treatment recommendation. Please consult a qualified physician.â€</p>
</blockquote>
<hr />
<h2 id="configuration-options">7. Configuration Options</h2>
<p>All options configurable via environment variables (<code>.env</code> file).</p>
<table>
<colgroup>
<col style="width: 30%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr class="header">
<th>Option</th>
<th>Default</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>MAX_FILE_SIZE</code></td>
<td>20 MB</td>
<td>Maximum upload file size</td>
</tr>
<tr class="even">
<td><code>MAX_PAGES</code></td>
<td>30</td>
<td>Maximum page count per report</td>
</tr>
<tr class="odd">
<td><code>RETENTION_PERIOD</code></td>
<td>48h</td>
<td>Temporary storage auto-deletion period</td>
</tr>
<tr class="even">
<td><code>VALIDATION_THRESHOLD</code></td>
<td>0.8</td>
<td>Pre-validation LLM confidence threshold</td>
</tr>
<tr class="odd">
<td><code>LLM_ANALYSIS_MODEL</code></td>
<td>gpt-4o</td>
<td>Primary LLM model for report analysis</td>
</tr>
<tr class="even">
<td><code>LLM_VALIDATION_MODEL</code></td>
<td>gpt-4o-mini</td>
<td>Cheap LLM for pre-validation</td>
</tr>
<tr class="odd">
<td><code>LLM_API_KEY</code></td>
<td>(required)</td>
<td>OpenAI API key</td>
</tr>
<tr class="even">
<td><code>OCR_ENGINE</code></td>
<td>PaddleOCR</td>
<td>OCR engine; alternative: <code>aws_textract</code></td>
</tr>
<tr class="odd">
<td><code>RATE_LIMIT_PER_IP</code></td>
<td>10/hour</td>
<td>Maximum report submissions per IP per hour</td>
</tr>
<tr class="even">
<td><code>RECAPTCHA_SECRET_KEY</code></td>
<td>(required)</td>
<td>Google reCAPTCHA v3 server-side secret</td>
</tr>
<tr class="odd">
<td><code>RECAPTCHA_SITE_KEY</code></td>
<td>(required)</td>
<td>Google reCAPTCHA v3 client-side key</td>
</tr>
<tr class="even">
<td><code>TWILIO_ACCOUNT_SID</code></td>
<td>(required for WhatsApp)</td>
<td>Twilio account SID</td>
</tr>
<tr class="odd">
<td><code>TWILIO_AUTH_TOKEN</code></td>
<td>(required for WhatsApp)</td>
<td>Twilio auth token</td>
</tr>
<tr class="even">
<td><code>TWILIO_WHATSAPP_NUMBER</code></td>
<td>(required for WhatsApp)</td>
<td>Twilio WhatsApp sender number</td>
</tr>
<tr class="odd">
<td><code>MYSQL_URL</code></td>
<td>mysql://localhost:3306/labreportai</td>
<td>MySQL connection string</td>
</tr>
<tr class="even">
<td><code>REDIS_URL</code></td>
<td>redis://localhost:6379/0</td>
<td>Redis connection string</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="safety-security-privacy">8. Safety, Security &amp; Privacy</h2>
<h3 id="pii-sanitization">PII Sanitization</h3>
<p>All personal information scrubbed from OCR text <strong>before</strong> sending to the LLM:</p>
<table>
<thead>
<tr class="header">
<th>PII Type</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Patient Name</td>
<td>Replaced with <code>[REDACTED]</code></td>
</tr>
<tr class="even">
<td>Patient ID / MRN</td>
<td>Removed</td>
</tr>
<tr class="odd">
<td>Phone Number</td>
<td>Replaced with <code>[PHONE_REDACTED]</code></td>
</tr>
<tr class="even">
<td>Address</td>
<td>Removed</td>
</tr>
<tr class="odd">
<td>Date of Birth</td>
<td>Replaced with <code>[DOB_REDACTED]</code> (age passed separately)</td>
</tr>
<tr class="even">
<td>Doctor Name</td>
<td>Replaced with <code>[DOCTOR_REDACTED]</code></td>
</tr>
<tr class="odd">
<td>Hospital / Lab Name</td>
<td>Replaced with <code>[LAB_REDACTED]</code></td>
</tr>
</tbody>
</table>
<h3 id="security-measures">Security Measures</h3>
<ul>
<li><strong>HTTPS</strong> required for all communications.</li>
<li><strong>Google reCAPTCHA v3</strong> (invisible, score-based) on website uploads.</li>
<li><strong>Per-IP rate limiting</strong> â€” 10 requests/hour (configurable).</li>
<li><strong>No user authentication</strong> for v1 â€” anonymous usage.</li>
<li>Temporary file storage with <strong>24â€“48h auto-deletion</strong> via Celery Beat.</li>
<li>No permanent storage of uploaded lab reports or generated outputs.</li>
</ul>
<hr />
<h2 id="database-schema">9. Database Schema</h2>
<h3 id="mysql-reports-table-v1">MySQL â€” <code>reports</code> Table (v1)</h3>
<table>
<thead>
<tr class="header">
<th>Column</th>
<th>Type</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>id</code></td>
<td>VARCHAR(36) PK</td>
<td>UUID</td>
</tr>
<tr class="even">
<td><code>job_id</code></td>
<td>VARCHAR(36) UNIQUE</td>
<td>Celery task ID</td>
</tr>
<tr class="odd">
<td><code>status</code></td>
<td>ENUM</td>
<td><code>pending</code>, <code>processing</code>, <code>completed</code>, <code>failed</code></td>
</tr>
<tr class="even">
<td><code>file_path</code></td>
<td>VARCHAR(500)</td>
<td>Path to uploaded file in storage volume</td>
</tr>
<tr class="odd">
<td><code>file_type</code></td>
<td>VARCHAR(50)</td>
<td>MIME type</td>
</tr>
<tr class="even">
<td><code>age</code></td>
<td>INTEGER</td>
<td>Nullable</td>
</tr>
<tr class="odd">
<td><code>gender</code></td>
<td>VARCHAR(10)</td>
<td>Nullable</td>
</tr>
<tr class="even">
<td><code>language</code></td>
<td>VARCHAR(5)</td>
<td>Default <code>en</code></td>
</tr>
<tr class="odd">
<td><code>ocr_text</code></td>
<td>LONGTEXT</td>
<td>Scrubbed OCR text; nullable</td>
</tr>
<tr class="even">
<td><code>result_json</code></td>
<td>LONGTEXT</td>
<td>Structured LLM output as JSON; nullable</td>
</tr>
<tr class="odd">
<td><code>result_markdown</code></td>
<td>LONGTEXT</td>
<td>Rendered markdown; nullable</td>
</tr>
<tr class="even">
<td><code>result_pdf_path</code></td>
<td>VARCHAR(500)</td>
<td>Path to generated PDF; nullable</td>
</tr>
<tr class="odd">
<td><code>error_message</code></td>
<td>TEXT</td>
<td>Error details if failed; nullable</td>
</tr>
<tr class="even">
<td><code>source</code></td>
<td>ENUM</td>
<td><code>web</code>, <code>whatsapp</code>; default <code>web</code></td>
</tr>
<tr class="odd">
<td><code>whatsapp_number</code></td>
<td>VARCHAR(20)</td>
<td>Phone number for WhatsApp reports; nullable</td>
</tr>
<tr class="even">
<td><code>ip_address</code></td>
<td>VARCHAR(45)</td>
<td>Client IP for rate limiting</td>
</tr>
<tr class="odd">
<td><code>expires_at</code></td>
<td>DATETIME</td>
<td>Auto-deletion timestamp</td>
</tr>
<tr class="even">
<td><code>created_at</code></td>
<td>DATETIME</td>
<td>Server default NOW</td>
</tr>
<tr class="odd">
<td><code>updated_at</code></td>
<td>DATETIME</td>
<td>On update NOW</td>
</tr>
</tbody>
</table>
<p><strong>Note:</strong> User management tables deferred to future versions.</p>
<h3 id="redis-keys">Redis Keys</h3>
<ul>
<li><code>celery</code> â€” Celery broker and result backend</li>
<li><code>whatsapp:{phone_number}</code> â€” JSON hash: <code>{ state, age, gender, job_id }</code>. TTL: 30 minutes.</li>
<li><code>rate_limit:{ip}</code> â€” Integer counter. TTL: 1 hour.</li>
</ul>
<hr />
<h2 id="acceptance-criteria-test-scenarios">10. Acceptance Criteria / Test Scenarios</h2>
<ol type="1">
<li>Upload PDF/JPG/PNG â†’ validated â†’ OCR â†’ LLM analysis â†’ Markdown + PDF returned</li>
<li>WhatsApp flow: sequential Age/Gender/Report capture via Twilio â†’ text + PDF delivered</li>
<li>WhatsApp sends brief text message + PDF attachment (no raw markdown)</li>
<li>Blurred/low-quality images â†’ rejected with re-upload message</li>
<li>Non-lab documents (receipt, letter) â†’ rejected with â€œnot a lab reportâ€ message</li>
<li>Urdu translation preserves medical terms in parenthetical English</li>
<li>Bar + gauge charts accurately reflect abnormal/critical values in PDF</li>
<li>All configuration options applied correctly (file size, pages, LLM model, OCR engine)</li>
<li>Reference range sources displayed; fallback note shown when ranges not on report</li>
<li>Disclaimers present on all Markdown and PDF outputs</li>
<li>reCAPTCHA v3 blocks bot submissions on website</li>
<li>Per-IP rate limiting enforced â€” 11th request in 1 hour returns 429</li>
<li>PII fully scrubbed â€” no personal info reaches the LLM</li>
<li>Files auto-deleted after retention period (24â€“48h)</li>
<li>Polling endpoint returns correct status transitions: <code>pending</code> â†’ <code>processing</code> â†’ <code>completed</code>/<code>failed</code></li>
<li>Docker Compose starts all services: FastAPI, Celery worker, Celery Beat, Redis, MySQL, Next.js</li>
</ol>
<hr />
<h2 id="project-structure">11. Project Structure</h2>
<pre><code>labreportai/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ docker-compose.prod.yml
â”œâ”€â”€ Caddyfile
â”œâ”€â”€ deploy.sh
â”œâ”€â”€ .env.example
â”œâ”€â”€ .env.production.example
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ spec.md
â”‚
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ Dockerfile.prod
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ next.config.js
â”‚   â”œâ”€â”€ tailwind.config.js
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ .env.local.example
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ app/
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ globals.css
â”‚       â”‚   â””â”€â”€ report/[jobId]/page.tsx
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ ui/                  (shadcn/ui components)
â”‚       â”‚   â”œâ”€â”€ UploadForm.tsx
â”‚       â”‚   â”œâ”€â”€ ReportView.tsx
â”‚       â”‚   â”œâ”€â”€ StatusPoller.tsx
â”‚       â”‚   â””â”€â”€ DisclaimerBanner.tsx
â”‚       â”œâ”€â”€ lib/
â”‚       â”‚   â”œâ”€â”€ api.ts
â”‚       â”‚   â””â”€â”€ utils.ts
â”‚       â””â”€â”€ types/
â”‚           â””â”€â”€ index.ts
â”‚
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”œâ”€â”€ alembic.ini
â”‚   â”œâ”€â”€ alembic/
â”‚   â”‚   â””â”€â”€ versions/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ main.py                  (FastAPI app factory)
â”‚   â”‚   â”œâ”€â”€ config.py                (Pydantic Settings)
â”‚   â”‚   â”œâ”€â”€ dependencies.py
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ router.py
â”‚   â”‚   â”‚   â”œâ”€â”€ v1/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ reports.py       (POST /analyze-report, GET /status, GET /download)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ whatsapp.py      (Twilio webhook)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ health.py        (GET /health)
â”‚   â”‚   â”‚   â””â”€â”€ middleware.py        (rate limiting, CORS)
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â””â”€â”€ report.py            (SQLAlchemy model)
â”‚   â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”‚   â””â”€â”€ report.py            (Pydantic request/response schemas)
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ ocr.py               (PaddleOCR wrapper)
â”‚   â”‚   â”‚   â”œâ”€â”€ pii_scrubber.py      (Regex-based PII removal)
â”‚   â”‚   â”‚   â”œâ”€â”€ llm_validator.py     (Pre-validation with GPT-4o-mini)
â”‚   â”‚   â”‚   â”œâ”€â”€ llm_analyzer.py      (Main analysis with GPT-4o)
â”‚   â”‚   â”‚   â”œâ”€â”€ translator.py        (English â†’ Urdu translation)
â”‚   â”‚   â”‚   â”œâ”€â”€ chart_generator.py   (Matplotlib bar + gauge charts)
â”‚   â”‚   â”‚   â”œâ”€â”€ pdf_generator.py     (WeasyPrint HTML â†’ PDF)
â”‚   â”‚   â”‚   â”œâ”€â”€ markdown_renderer.py (JSON â†’ formatted Markdown)
â”‚   â”‚   â”‚   â”œâ”€â”€ file_validator.py    (Type, size, page count validation)
â”‚   â”‚   â”‚   â”œâ”€â”€ file_cleanup.py      (Auto-deletion logic)
â”‚   â”‚   â”‚   â””â”€â”€ whatsapp_sender.py   (Twilio outbound messages)
â”‚   â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â”‚   â”œâ”€â”€ celery_app.py        (Celery configuration)
â”‚   â”‚   â”‚   â”œâ”€â”€ analyze.py           (Main pipeline task)
â”‚   â”‚   â”‚   â””â”€â”€ cleanup.py           (Periodic cleanup task)
â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â””â”€â”€ session.py           (SQLAlchemy engine + session)
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â”œâ”€â”€ logging.py           (Logging configuration)
â”‚   â”‚       â””â”€â”€ recaptcha.py         (reCAPTCHA v3 verification)
â”‚   â”œâ”€â”€ prompts/
â”‚   â”‚   â”œâ”€â”€ pre_validation.txt
â”‚   â”‚   â”œâ”€â”€ analysis.txt
â”‚   â”‚   â””â”€â”€ translation.txt
â”‚   â””â”€â”€ tests/
â”‚       â”œâ”€â”€ conftest.py
â”‚       â”œâ”€â”€ fixtures/               (Sample lab reports for testing)
â”‚       â”œâ”€â”€ test_file_validator.py
â”‚       â”œâ”€â”€ test_pii_scrubber.py
â”‚       â”œâ”€â”€ test_ocr.py
â”‚       â”œâ”€â”€ test_llm_analyzer.py
â”‚       â”œâ”€â”€ test_chart_generator.py
â”‚       â”œâ”€â”€ test_pdf_generator.py
â”‚       â”œâ”€â”€ test_api_reports.py
â”‚       â”œâ”€â”€ test_whatsapp.py
â”‚       â””â”€â”€ e2e/
â”‚           â”œâ”€â”€ test_full_pipeline_web.py
â”‚           â””â”€â”€ test_full_pipeline_whatsapp.py
â”‚
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ pdf/
â”‚       â”œâ”€â”€ report.html              (Jinja2 template for WeasyPrint)
â”‚       â””â”€â”€ styles.css
â”‚
â””â”€â”€ storage/                          (Docker volume mount)
    â”œâ”€â”€ uploads/
    â””â”€â”€ outputs/</code></pre>
<hr />
<h2 id="implementation-plan-7-phases">12. Implementation Plan (7 Phases)</h2>
<p>Development follows a <strong>vertical slice</strong> approach â€” each phase delivers a working increment. Minimal unit tests per phase; comprehensive E2E tests in the final phase.</p>
<h3 id="phase-1-foundation-infrastructure">Phase 1: Foundation &amp; Infrastructure</h3>
<p><strong>Goal:</strong> Establish the monorepo, Docker Compose infrastructure, database, Celery plumbing, and a minimal end-to-end loop with a stub task. Upload a file â†’ see a placeholder result.</p>
<p><strong>What to build:</strong> - Monorepo scaffold: <code>/frontend</code> (Next.js + Tailwind + shadcn/ui), <code>/backend</code> (FastAPI) - <code>docker-compose.yml</code> with services: <code>backend</code>, <code>celery-worker</code>, <code>redis</code>, <code>mysql</code>, <code>frontend</code> - <code>.env.example</code> with all configuration variables - SQLAlchemy + Alembic setup; initial migration creates <code>reports</code> table - Pydantic Settings (<code>config.py</code>) reading env vars - <code>POST /v1/analyze-report</code> â€” saves file to storage volume, creates DB row (status=<code>pending</code>), dispatches Celery task, returns <code>{ "job_id": "..." }</code> - <code>GET /v1/status/{job_id}</code> â€” queries DB, returns status + results - Stub Celery task: sleeps 3 seconds, updates DB to <code>completed</code> with placeholder markdown - File validation service: checks MIME type, file size, page count - Next.js upload form (file input, age, gender, language selector) - Polling component: redirects to <code>/report/{jobId}</code>, polls every 3 seconds, shows spinner - Basic result display (raw text for now)</p>
<p><strong>Verify:</strong> <code>docker-compose up --build</code> â†’ open <code>http://localhost:3000</code> â†’ upload a PDF â†’ see placeholder text after ~3 seconds. Invalid files rejected.</p>
<hr />
<h3 id="phase-2-ocr-pii-scrubbing-pre-validation">Phase 2: OCR, PII Scrubbing &amp; Pre-Validation</h3>
<p><strong>Goal:</strong> Replace the stub with real OCR extraction, PII scrubbing, and pre-validation. Upload a real lab report â†’ see scrubbed extracted text. Non-lab documents rejected.</p>
<p><strong>What to build:</strong> - <code>ocr.py</code> â€” PaddleOCR wrapper. Handles images (direct OCR) and PDFs (convert pages to images via <code>pdf2image</code>, then OCR). Garbage text detection heuristic. - <code>pii_scrubber.py</code> â€” Regex-based scrubbing for all 7 PII categories (name, ID, phone, address, DOB, doctor, hospital). - <code>llm_validator.py</code> â€” LangChain + GPT-4o-mini. Loads prompt from <code>prompts/pre_validation.txt</code>. Returns <code>(is_lab_report, confidence)</code>. Compares against <code>VALIDATION_THRESHOLD</code>. - <code>prompts/pre_validation.txt</code> â€” Prompt instructing LLM to classify document as lab report or not. - Update Celery task: OCR â†’ PII scrub â†’ pre-validate â†’ store scrubbed text in DB. - Alembic migration: add <code>ocr_text</code> column. - Update Dockerfile: add PaddleOCR system dependencies, <code>poppler-utils</code>. - Tests: <code>test_file_validator.py</code>, <code>test_pii_scrubber.py</code>, <code>test_ocr.py</code>.</p>
<p><strong>Verify:</strong> Upload real lab report â†’ see scrubbed text (placeholder for analysis). Upload receipt â†’ rejected. Upload blurred image â†’ rejected.</p>
<hr />
<h3 id="phase-3-llm-analysis-core-intelligence">Phase 3: LLM Analysis (Core Intelligence)</h3>
<p><strong>Goal:</strong> Full LLM interpretation. Upload a lab report â†’ see a complete, meaningful 7-section interpretation with color-coded indicators.</p>
<p><strong>What to build:</strong> - <code>llm_analyzer.py</code> â€” LangChain + GPT-4o. Sends scrubbed text + age/gender. Returns structured JSON matching the output schema below. Uses LangChain output parsers. Retry logic (up to 2 retries). - <code>prompts/analysis.txt</code> â€” Main analysis prompt (most critical prompt in the system). Instructs LLM to produce structured JSON with all 7 sections, severity classification, reference range sourcing. - <strong>Structured JSON output schema:</strong> <code>json   {     "patient_info": { "age": null, "gender": null, "report_date": null },     "summary": "...",     "categories": [       {         "name": "Complete Blood Count (CBC)",         "tests": [           {             "test_name": "Hemoglobin",             "value": 12.5,             "unit": "g/dL",             "reference_range": "13.0 - 17.0",             "reference_source": "report | standard_knowledge",             "severity": "normal | borderline | critical",             "interpretation": "..."           }           // Note: `value` supports both numeric (12.5) and string ("Positive", "Reactive", "1+")           // for qualitative lab results.         ]       }     ],     "abnormal_analysis": "...",     "clinical_associations": "...",     "lifestyle_tips": "...",     "disclaimer": "..."   }</code> - <code>markdown_renderer.py</code> â€” Converts JSON to formatted markdown with emoji circle indicators (ğŸŸ¢/ğŸŸ¡/ğŸ”´), tables per category, and all 7 sections. - Frontend: install <code>react-markdown</code> + <code>remark-gfm</code>, render backend-generated markdown in <code>ReportView.tsx</code>. No custom React components from JSON â€” markdown-only rendering approach. - <code>value</code> field supports both numeric and string types for qualitative lab results (e.g., â€œPositiveâ€, â€œReactiveâ€). - Alembic migration: add <code>result_json</code> column if not already present. - Tests: <code>test_llm_analyzer.py</code> (mock LLM API).</p>
<p><strong>Verify:</strong> Upload a CBC report â†’ see full interpretation with color-coded tables, severity labels, reference ranges, clinical associations, lifestyle tips, disclaimer.</p>
<hr />
<h3 id="phase-4-charts-pdf-generation">Phase 4: Charts &amp; PDF Generation</h3>
<p><strong>Goal:</strong> Generate bar + gauge charts and a polished PDF. Upload a report â†’ download a professional PDF with embedded charts.</p>
<p><strong>What to build:</strong> - <code>chart_generator.py</code> â€” Matplotlib: - <code>generate_bar_chart()</code> â€” Horizontal bar chart per test category. Value vs.Â reference range. Color-coded bars (green/yellow/red). - <code>generate_gauge_chart()</code> â€” Speedometer-style gauge for each critical/abnormal value. Green/yellow/red zones, needle pointer. - <code>generate_all_charts()</code> â€” Orchestrator. Saves PNGs to <code>/storage/outputs/{job_id}/charts/</code>. - <code>pdf_generator.py</code> â€” WeasyPrint: - Loads Jinja2 template from <code>templates/pdf/report.html</code>. - Renders all 7 sections, color-coded table rows, embedded chart images. - Outputs PDF to <code>/storage/outputs/{job_id}/report.pdf</code>. - <code>templates/pdf/report.html</code> â€” Full Jinja2 HTML template with professional layout. - <code>templates/pdf/styles.css</code> â€” Print-optimized CSS: color badges, page margins, chart sizing, page breaks, disclaimer styling. - <code>GET /v1/download/{job_id}</code> â€” Returns PDF via <code>FileResponse</code>. - Frontend: â€œDownload PDF Reportâ€ button in <code>ReportView.tsx</code>. - Tests: <code>test_chart_generator.py</code>, <code>test_pdf_generator.py</code>.</p>
<p><strong>Verify:</strong> Upload report with abnormal values â†’ download PDF â†’ verify: professional layout, color tables, bar charts per category, gauge charts for critical values, all 7 sections, disclaimer.</p>
<hr />
<h3 id="phase-5-security-rate-limiting-file-cleanup">Phase 5: Security, Rate Limiting &amp; File Cleanup</h3>
<p><strong>Goal:</strong> Production-harden the website. reCAPTCHA blocks bots, rate limiting prevents abuse, old files auto-deleted.</p>
<p><strong>What to build:</strong> - <code>recaptcha.py</code> â€” Verifies reCAPTCHA v3 token via Google API. Returns <code>(success, score)</code>. Configurable score threshold. - Frontend: integrate reCAPTCHA v3 script. Execute before form submit, include token in request. - <code>middleware.py</code> â€” Redis-based per-IP rate limiter. Uses <code>INCR</code> + <code>EXPIRE</code> on <code>rate_limit:{ip}</code> key. Returns 429 with <code>Retry-After</code> header when exceeded. - <code>file_cleanup.py</code> â€” Queries expired reports from DB, deletes files from storage, updates/removes DB records. - <code>tasks/cleanup.py</code> â€” Celery task wrapping cleanup logic. - Celery Beat schedule: run cleanup every hour. - <code>docker-compose.yml</code> â€” Add <code>celery-beat</code> service. - Alembic migration: add <code>expires_at</code> column. - Global exception handlers in <code>main.py</code>: consistent error JSON for 422, 429, 500. - Tests: <code>test_api_reports.py</code> (reCAPTCHA mock, rate limiting, cleanup).</p>
<p><strong>Decisions:</strong> - <strong>reCAPTCHA enforcement</strong>: Optional â€” auto-skipped when <code>RECAPTCHA_SECRET_KEY</code> is empty. Enforced only when keys are configured. Allows development without Google keys. - <strong>File cleanup behavior</strong>: Hard delete â€” delete uploaded files, generated PDFs/charts, AND remove the database record entirely. No trace remains after expiry. - <strong>Rate limiting scope</strong>: Upload endpoint only (<code>POST /v1/analyze-report</code>, 10/hour per IP). Status polling and PDF downloads remain unlimited. - <strong>Celery Beat deployment</strong>: Separate <code>celery-beat</code> Docker container in docker-compose.yml (same image, different command). Avoids duplicate runs with multiple workers.</p>
<p><strong>Verify:</strong> reCAPTCHA blocks invalid tokens (when keys configured). 11th request from same IP returns 429. Old records with expired files cleaned up by Celery Beat.</p>
<hr />
<h3 id="phase-6-translation-whatsapp-integration">Phase 6: Translation &amp; WhatsApp Integration</h3>
<p><strong>Goal:</strong> Add Urdu translation and the full Twilio WhatsApp bot. Both interfaces fully functional.</p>
<p><strong>What to build:</strong> - <code>translator.py</code> â€” LangChain LLM call. Translates structured JSON from English to Urdu. Medical terms preserved with English in parentheses. Loads prompt from <code>prompts/translation.txt</code>. - <code>prompts/translation.txt</code> â€” Translation prompt with strict rules for medical term preservation. - RTL support in <code>templates/pdf/report.html</code> for Urdu output. - Urdu fonts added to backend Docker image (<code>fonts-noto-extra</code> or bundled <code>.ttf</code>). - Frontend: language selector triggers translation when set to Urdu. - <code>v1/whatsapp.py</code> â€” Twilio webhook endpoint: - Receives messages, manages Redis state machine: <code>AWAITING_AGE</code> â†’ <code>AWAITING_GENDER</code> â†’ <code>AWAITING_REPORT</code> â†’ <code>PROCESSING</code>. - Validates inputs (age: 1-120, gender: Male/Female/Other). - Downloads media from Twilio URL, dispatches Celery task. - Returns TwiML XML responses. - <code>whatsapp_sender.py</code> â€” Twilio outbound: send text message + PDF media via Twilio API. - Update Celery task: after completion for WhatsApp reports, call sender to deliver text + PDF. - Alembic migration: add <code>source</code> (web/whatsapp) and <code>whatsapp_number</code> columns. - Redis keys: <code>whatsapp:{phone_number}</code> with 30-minute TTL. - Tests: <code>test_whatsapp.py</code>.</p>
<p><strong>Decisions:</strong> - <strong>Twilio/WhatsApp</strong>: Optional â€” endpoint registered but returns 503 when Twilio keys are empty/placeholder. No crash in dev mode. - <strong>Translation LLM</strong>: Use validation model (8B) by default, but configurable via <code>LLM_TRANSLATION_MODEL</code> env var. Add <code>get_translation_llm()</code> factory. - <strong>Pipeline flow</strong>: Translate JSON â†’ render Urdu markdown â†’ generate Urdu PDF. Charts stay numeric (language-neutral). One coherent Urdu output. - <strong>Urdu fonts</strong>: Install <code>fonts-noto-extra</code> Debian package in Dockerfile.</p>
<p><strong>Verify:</strong> Website with Urdu translation â€” medical terms in parentheses. WhatsApp: send age â†’ gender â†’ photo â†’ receive text + PDF.</p>
<hr />
<h3 id="phase-7-e2e-testing-polish-production-readiness">Phase 7: E2E Testing, Polish &amp; Production Readiness</h3>
<p><strong>Goal:</strong> Comprehensive testing, error hardening, frontend polish, production Docker config. System ready for deployment.</p>
<p><strong>What to build:</strong> - <code>tests/e2e/test_full_pipeline_web.py</code> â€” 10+ test scenarios: valid reports, multi-panel, blurred, receipt, oversized, Urdu, rate limit, reCAPTCHA, concurrent uploads. - <code>tests/e2e/test_full_pipeline_whatsapp.py</code> â€” Full flow, invalid inputs, session timeout, message during processing. - <code>tests/fixtures/</code> â€” Sample lab report files for testing. - Error handling hardening: specific error messages per failure type in Celery task. Graceful degradation (PDF fails â†’ still return markdown). - Logging audit: ensure no PII or sensitive data in logs. - Frontend polish: - File drag-and-drop zone. - Client-side file validation (type, size). - Progress steps during processing (â€œExtracting textâ€¦â€, â€œAnalyzing reportâ€¦â€, â€œGenerating PDFâ€¦â€). - Responsive design (desktop + mobile). - Accessible: ARIA attributes, keyboard navigation. - â€œUpload Another Reportâ€ button. - <code>v1/health.py</code> â€” Health check verifying MySQL, Redis, Celery connectivity. - <code>docker-compose.prod.yml</code> â€” Production overrides: multi-stage Docker builds, <code>next build &amp;&amp; next start</code>, uvicorn with 4 workers, health checks, restart policies, resource limits. - Frontend Dockerfile: multi-stage build (build â†’ standalone production). - Backend Dockerfile: non-root user, smaller image. - <code>README.md</code> â€” Setup instructions, architecture, environment variables, API docs, troubleshooting.</p>
<p><strong>Verify:</strong> - <code>docker-compose -f docker-compose.yml -f docker-compose.prod.yml up --build</code> â€” all services start. - <code>pytest tests/</code> â€” all unit + E2E tests pass. - Manual: full website flow on desktop + mobile. - Manual: full WhatsApp flow. - <code>GET /v1/health</code> returns all services healthy. - Docker logs: structured, no sensitive data.</p>
<p><strong>Phase 7 Implementation Decisions:</strong></p>
<p><strong>Decision 1 â€” Test Data &amp; Fixtures:</strong> - Use existing sample files in <code>samples/</code> folder (no additional fixtures needed) - Valid lab reports for positive testing: - <code>samples/Culture-Urine.pdf</code> - <code>samples/HIGH SENSITIVE TROPONIN -I.pdf</code> - <code>samples/Urine DR.pdf</code> - Non-lab documents for rejection testing: - <code>samples/Lab Receipt.pdf</code> - <code>samples/Lab Receipt2.pdf</code> - Total: 3 valid reports + 2 rejection test cases</p>
<p><strong>Decision 2 â€” LLM Testing Strategy:</strong> - Use real LLM calls for E2E tests (Option A) - Tests will verify actual integration with LLM providers - Requires valid API keys in test environment - Expected test duration: ~5-10s per test - Catches real API issues, response format changes, and integration problems</p>
<p><strong>Decision 3 â€” WhatsApp E2E Testing:</strong> - Use mocked Twilio webhook requests (Option A) - Simulate Twilio POST requests with test payloads - Mock Twilio media download API - No actual WhatsApp messages sent during automated tests - Real Twilio integration testing deferred to manual testing</p>
<p><strong>Decision 4 â€” Test Scenario Priorities:</strong> - Implement only must-have scenarios (Option A) - 5 core tests - Test coverage: 1. Valid lab report â†’ successful analysis (English) 2. Valid lab report â†’ successful analysis (Urdu) 3. Non-lab document (receipt) â†’ rejected with clear error 4. Oversized file â†’ rejected 5. Invalid file type â†’ rejected - Additional scenarios (multi-panel, blurred, rate limiting, concurrent uploads) deferred</p>
<p><strong>Decision 5 â€” Frontend Polish Features:</strong> - Implement all features (Option D) - complete polish - Features to implement: 1. File drag-and-drop zone with visual feedback 2. Client-side file validation (type: PDF/PNG/JPEG, size: max 10MB) 3. Real-time progress indicators with polling (steps: â€œExtracting textâ€¦â€, â€œAnalyzing reportâ€¦â€, â€œGenerating PDFâ€¦â€) 4. Responsive design with mobile-friendly layout (media queries, touch targets) 5. Accessibility: ARIA attributes, keyboard navigation, screen reader support 6. â€œUpload Another Reportâ€ button on results page</p>
<p><strong>Decision 6 â€” Health Check Endpoint Scope:</strong> - Implement dependency checks (Option B) - Health checks to implement: 1. MySQL connectivity check (simple SELECT 1 query) 2. Redis connectivity check (PING command) 3. Celery worker availability check (inspect active workers) - Response format: <code>{"status": "healthy|unhealthy", "checks": {"mysql": "ok|error", "redis": "ok|error", "celery": "ok|error"}}</code> - Fast response (~100-200ms) - Skip LLM/Twilio API checks to avoid external dependencies</p>
<p><strong>Decision 7 â€” README Documentation Depth:</strong> - Quick Start documentation (Option A) - Sections to include: 1. Project overview and features 2. Quick start (docker-compose up instructions) 3. Basic usage (how to upload a report) 4. Environment variables list with required/optional markers 5. Brief troubleshooting (common Docker issues) - Target length: 1-2 pages - Focus on getting users up and running quickly</p>
<p><strong>Decision 8 â€” Logging Audit:</strong> - Comprehensive audit (Option B) - Audit tasks: 1. Review all logging statements across backend codebase 2. Create PII detection patterns (phone numbers, emails, patient names, test values) 3. Implement log sanitization utility function 4. Update all logs to sanitize sensitive data 5. Test with real sample reports to verify no PII leaks - PII to scrub: patient names, phone numbers, email addresses, test result values, addresses - Keep safe: job_id, file types, error types, processing steps, timing metrics</p>
<p><strong>Decision 9 â€” Error Handling Hardening:</strong> - Specific error messages (Option B) - Error categories to implement: 1. OCR errors: â€œText extraction failed - image quality too lowâ€, â€œText extraction failed - unsupported formatâ€ 2. Pre-validation errors: â€œDocument rejected - not a lab reportâ€, â€œDocument rejected - insufficient medical dataâ€ 3. LLM errors: â€œAnalysis failed - LLM timeoutâ€, â€œAnalysis failed - invalid response formatâ€, â€œAnalysis failed - rate limit exceededâ€ 4. PDF errors: â€œPDF generation failed - chart rendering errorâ€, â€œPDF generation failed - template errorâ€ 5. Translation errors: Already handled - falls back to English - User-facing messages: Clear, actionable guidance - Backend logs: Detailed error codes + stack traces for debugging - No graceful degradation (except translation) - full processing or clear failure</p>
<hr />
<h2 id="phase-dependency-chain">13. Phase Dependency Chain</h2>
<pre><code>Phase 1: Foundation &amp; Infrastructure
    â”‚
    â–¼
Phase 2: OCR, PII Scrubbing &amp; Pre-Validation
    â”‚
    â–¼
Phase 3: LLM Analysis (Core Intelligence)
    â”‚
    â–¼
Phase 4: Charts &amp; PDF Generation
    â”‚
    â–¼
Phase 5: Security, Rate Limiting &amp; File Cleanup
    â”‚
    â–¼
Phase 6: Translation &amp; WhatsApp Integration
    â”‚
    â–¼
Phase 7: E2E Testing, Polish &amp; Production Readiness</code></pre>
<p>Each phase builds on the previous. After Phase 1, you have a working stub loop. After Phase 4, the entire website pipeline works end-to-end with real analysis. Phases 5â€“6 add security and the secondary interface. Phase 7 hardens everything for production.</p>
<hr />
<h2 id="future-considerations-post-v1">14. Future Considerations (Post-v1)</h2>
<ul>
<li>User accounts and authentication (registration/login, report history)</li>
<li>Additional languages beyond English + Urdu</li>
<li>CI/CD pipeline (GitHub Actions: lint, test, build, deploy)</li>
<li>AWS S3 file storage option (for production scalability)</li>
<li>Mobile app</li>
<li>EHR/EMR integration</li>
<li>Advanced analytics dashboard</li>
<li>Multi-language input report support</li>
</ul>
<hr />
<h2 id="production-deployment">15. Production Deployment</h2>
<h3 id="production-architecture">Production Architecture</h3>
<pre><code>Internet â†’ Caddy (HTTPS :443) â†’ Frontend (:3000)
                                â†’ Backend  (:8000)
         Internal only:
           MySQL (:3306), Redis (:6379), Celery Worker, Celery Beat</code></pre>
<p>All 7 services run on a single VPS via Docker Compose. Caddy handles HTTPS termination and reverse proxying. Only ports 80 and 443 are exposed to the internet â€” all other services communicate internally via Docker networking.</p>
<h3 id="hosting-oracle-cloud-always-free-tier">Hosting: Oracle Cloud Always-Free Tier</h3>
<table>
<thead>
<tr class="header">
<th>Item</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Provider</td>
<td>Oracle Cloud Infrastructure (OCI)</td>
</tr>
<tr class="even">
<td>VM Shape</td>
<td>VM.Standard.A1.Flex (ARM Ampere)</td>
</tr>
<tr class="odd">
<td>Resources</td>
<td>4 OCPUs, 24GB RAM, 200GB disk</td>
</tr>
<tr class="even">
<td>Cost</td>
<td>$0/month (permanently free, not trial)</td>
</tr>
<tr class="odd">
<td>OS</td>
<td>Ubuntu 22.04 (ARM)</td>
</tr>
</tbody>
</table>
<p>Oracle Cloudâ€™s Always-Free Tier provides an ARM Ampere A1 instance with 4 CPUs and 24GB RAM â€” more than sufficient for all services. This is not a 12-month trial; the resources remain free indefinitely.</p>
<h3 id="domain-ssl">Domain &amp; SSL</h3>
<table>
<thead>
<tr class="header">
<th>Item</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Domain</td>
<td>DuckDNS free subdomain (e.g., <code>labreportai.duckdns.org</code>)</td>
</tr>
<tr class="even">
<td>SSL</td>
<td>Automatic HTTPS via Caddy + Letâ€™s Encrypt</td>
</tr>
<tr class="odd">
<td>DNS Updates</td>
<td>Cron job updates DuckDNS IP every 5 minutes</td>
</tr>
</tbody>
</table>
<p>DuckDNS provides free dynamic DNS subdomains. A cron job keeps the DNS record updated with the serverâ€™s current IP address. Caddy automatically provisions and renews SSL certificates from Letâ€™s Encrypt.</p>
<h3 id="production-service-configuration">Production Service Configuration</h3>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 32%" />
<col style="width: 25%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="header">
<th>Service</th>
<th>Image / Build</th>
<th>RAM Limit</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Caddy</td>
<td><code>caddy:2-alpine</code></td>
<td>128 MB</td>
<td>Reverse proxy, auto-SSL, gzip compression</td>
</tr>
<tr class="even">
<td>Frontend</td>
<td><code>frontend/Dockerfile.prod</code></td>
<td>512 MB</td>
<td>Multi-stage build, Next.js standalone output (~150MB image)</td>
</tr>
<tr class="odd">
<td>Backend</td>
<td><code>backend/Dockerfile</code></td>
<td>2 GB</td>
<td>2 uvicorn workers, health checks every 30s</td>
</tr>
<tr class="even">
<td>Celery Worker</td>
<td>Same as backend</td>
<td>2 GB</td>
<td>2 concurrency, restart always</td>
</tr>
<tr class="odd">
<td>Celery Beat</td>
<td>Same as backend</td>
<td>256 MB</td>
<td>Periodic task scheduler</td>
</tr>
<tr class="even">
<td>MySQL</td>
<td><code>mysql:8.0</code></td>
<td>1 GB</td>
<td>Persistent volume, restart always</td>
</tr>
<tr class="odd">
<td>Redis</td>
<td><code>redis:7-alpine</code></td>
<td>256 MB</td>
<td>Celery broker + session cache</td>
</tr>
</tbody>
</table>
<h3 id="deployment-files">Deployment Files</h3>
<table>
<colgroup>
<col style="width: 40%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="header">
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>docker-compose.prod.yml</code></td>
<td>Production overrides: resource limits, restart policies, Caddy service, no port exposure for internal services</td>
</tr>
<tr class="even">
<td><code>frontend/Dockerfile.prod</code></td>
<td>Multi-stage Next.js build (<code>npm run build</code> â†’ standalone <code>node server.js</code>, ~150MB image)</td>
</tr>
<tr class="odd">
<td><code>Caddyfile</code></td>
<td>Reverse proxy routes: <code>/v1/*</code> â†’ backend, <code>/docs*</code> â†’ backend, everything else â†’ frontend. Auto-SSL.</td>
</tr>
<tr class="even">
<td><code>.env.production.example</code></td>
<td>Production environment template with secure defaults and placeholder passwords</td>
</tr>
<tr class="odd">
<td><code>deploy.sh</code></td>
<td>One-command VPS setup: installs Docker, clones repo, configures environment, opens firewall, launches all services</td>
</tr>
</tbody>
</table>
<h3 id="deployment-steps">Deployment Steps</h3>
<ol type="1">
<li><p><strong>Create Oracle Cloud account</strong> at cloud.oracle.com (free, credit card for identity verification only)</p></li>
<li><p><strong>Create ARM Compute Instance</strong>: Shape <code>VM.Standard.A1.Flex</code>, 4 OCPU, 24GB RAM, Ubuntu 22.04, 100GB boot volume</p></li>
<li><p><strong>Open ports 80 and 443</strong> in OCI Security List (VCN â†’ Subnet â†’ Security List â†’ Ingress Rules)</p></li>
<li><p><strong>Create DuckDNS subdomain</strong> at duckdns.org (sign in with GitHub), point to instance public IP</p></li>
<li><p><strong>SSH into the instance</strong> and run <code>deploy.sh</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clone and deploy</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone <span class="op">&lt;</span>repo-url<span class="op">&gt;</span> labreportai</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> labreportai</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> .env.production.example .env</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Edit .env with real passwords and API keys</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">nano</span> .env</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Launch all services</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span> deploy.sh</span></code></pre></div></li>
<li><p><strong>Verify deployment</strong>:</p>
<ul>
<li><code>https://labreportai.duckdns.org</code> â€” Frontend loads</li>
<li><code>https://labreportai.duckdns.org/v1/health</code> â€” Returns <code>{"status": "healthy"}</code></li>
<li>Upload a sample lab report â€” Full pipeline works</li>
<li><code>docker compose logs -f</code> â€” No errors in logs</li>
</ul></li>
</ol>
<h3 id="production-commands">Production Commands</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Start all services (production mode)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose <span class="at">-f</span> docker-compose.yml <span class="at">-f</span> docker-compose.prod.yml up <span class="at">-d</span> <span class="at">--build</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># View logs (follow)</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose <span class="at">-f</span> docker-compose.yml <span class="at">-f</span> docker-compose.prod.yml logs <span class="at">-f</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># View logs for a specific service</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose <span class="at">-f</span> docker-compose.yml <span class="at">-f</span> docker-compose.prod.yml logs <span class="at">-f</span> backend</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Restart a service</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose <span class="at">-f</span> docker-compose.yml <span class="at">-f</span> docker-compose.prod.yml restart backend</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop all services</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose <span class="at">-f</span> docker-compose.yml <span class="at">-f</span> docker-compose.prod.yml down</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Update and redeploy</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> pull</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose <span class="at">-f</span> docker-compose.yml <span class="at">-f</span> docker-compose.prod.yml up <span class="at">-d</span> <span class="at">--build</span></span></code></pre></div>
<h3 id="security-checklist">Security Checklist</h3>
<ul class="task-list">
<li><input type="checkbox" disabled="" />
Strong unique MySQL password in <code>.env</code> (not defaults)</li>
<li><input type="checkbox" disabled="" />
LLM API key set in <code>.env</code> (not committed to git)</li>
<li><input type="checkbox" disabled="" />
Caddy provides HTTPS (auto-SSL via Letâ€™s Encrypt)</li>
<li><input type="checkbox" disabled="" />
Only ports 80 and 443 open to internet</li>
<li><input type="checkbox" disabled="" />
Backend, MySQL, Redis not directly accessible from internet</li>
<li><input type="checkbox" disabled="" />
Oracle Cloud firewall configured (Security List ingress rules)</li>
<li><input type="checkbox" disabled="" />
CORS origins set to production domain only</li>
</ul>
<h3 id="cost-summary">Cost Summary</h3>
<table>
<thead>
<tr class="header">
<th>Item</th>
<th>Cost</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Oracle Cloud VM (ARM A1, 4 CPU / 24 GB)</td>
<td>$0/month (always free)</td>
</tr>
<tr class="even">
<td>DuckDNS subdomain</td>
<td>$0 (free)</td>
</tr>
<tr class="odd">
<td>SSL certificate (Letâ€™s Encrypt via Caddy)</td>
<td>$0 (free)</td>
</tr>
<tr class="even">
<td>Groq API (LLM â€” free tier: 30 req/min)</td>
<td>$0 (free)</td>
</tr>
<tr class="odd">
<td><strong>Total</strong></td>
<td><strong>$0/month</strong></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="detailed-deployment-guide">16. Detailed Deployment Guide</h2>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>Windows machine with Docker Desktop installed (for building images)</li>
<li>SSH key for Oracle Cloud instance</li>
<li>Oracle Cloud instance running Ubuntu (x86 or ARM)</li>
<li>DuckDNS subdomain pointing to server IP</li>
<li>OCI Security List with ports 80 and 443 open</li>
</ul>
<h3 id="step-1-server-initial-setup-one-time">Step 1: Server Initial Setup (One-time)</h3>
<p>SSH into your Oracle Cloud instance:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-i</span> <span class="st">&quot;path/to/your/ssh-key.key&quot;</span> ubuntu@YOUR_SERVER_IP</span></code></pre></div>
<p>Install Docker and Docker Compose:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Update system</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> apt upgrade <span class="at">-y</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Install Docker</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-fsSL</span> https://get.docker.com <span class="kw">|</span> <span class="fu">sudo</span> sh</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> usermod <span class="at">-aG</span> docker <span class="va">$USER</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Log out and back in for group changes</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="bu">exit</span></span></code></pre></div>
<p>SSH back in and clone the repository:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-i</span> <span class="st">&quot;path/to/your/ssh-key.key&quot;</span> ubuntu@YOUR_SERVER_IP</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Clone repository</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/YOUR_USERNAME/LabReportAI.git ~/labreportai</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/labreportai</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create environment file</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> .env.production.example .env</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">nano</span> .env  <span class="co"># Edit with your actual values</span></span></code></pre></div>
<h3 id="step-2-build-frontend-image-windows">Step 2: Build Frontend Image (Windows)</h3>
<p>The frontend must be built locally and transferred because: - Next.js standalone build embeds environment variables at build time - ARM/x86 architecture differences may cause issues building on server</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Navigate to frontend directory</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cd</span> <span class="st">&quot;path\to\labreportai\frontend&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the production image with environment variables</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>docker build <span class="op">-</span>f Dockerfile<span class="op">.</span><span class="fu">prod</span> `</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>build<span class="op">-</span>arg NEXT_PUBLIC_API_URL<span class="op">=</span>https<span class="op">://</span>YOUR_DOMAIN<span class="op">.</span><span class="fu">duckdns</span><span class="op">.</span><span class="fu">org</span> `</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>build<span class="op">-</span>arg NEXT_PUBLIC_RECAPTCHA_SITE_KEY<span class="op">=</span>placeholder `</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>t labreportai<span class="op">-</span>frontend<span class="op">:</span>latest <span class="op">.</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Save image to tar file</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>docker save labreportai<span class="op">-</span>frontend<span class="op">:</span>latest <span class="op">-</span>o frontend<span class="op">-</span>image<span class="op">.</span><span class="fu">tar</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Transfer to server</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>scp <span class="op">-</span>i <span class="st">&quot;path\to\your\ssh-key.key&quot;</span> frontend<span class="op">-</span>image<span class="op">.</span><span class="fu">tar</span> ubuntu@YOUR_SERVER_IP<span class="op">:~/</span></span></code></pre></div>
<h3 id="step-3-deploy-on-server">Step 3: Deploy on Server</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/labreportai</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Pull latest code</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> pull</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop existing services</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose <span class="at">-f</span> docker-compose.yml <span class="at">-f</span> docker-compose.prod.yml down</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove old frontend image (if exists)</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> image rm labreportai-frontend:latest <span class="dv">2</span><span class="op">&gt;</span>/dev/null <span class="kw">||</span> <span class="fu">true</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Prune old volumes (removes cached/stale data)</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> volume prune <span class="at">-f</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the new frontend image</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> load <span class="op">&lt;</span> ~/frontend-image.tar</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Start all services</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose <span class="at">-f</span> docker-compose.yml <span class="at">-f</span> docker-compose.prod.yml up <span class="at">-d</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Check logs</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose <span class="at">-f</span> docker-compose.yml <span class="at">-f</span> docker-compose.prod.yml logs <span class="at">-f</span></span></code></pre></div>
<h3 id="step-4-verify-deployment">Step 4: Verify Deployment</h3>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check all containers are running</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> ps</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check frontend logs</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose logs frontend</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check backend logs</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose logs backend</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Test health endpoint</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> https://YOUR_DOMAIN.duckdns.org/v1/health</span></code></pre></div>
<p>Visit <code>https://YOUR_DOMAIN.duckdns.org</code> in browser to verify the site loads correctly.</p>
<h3 id="redeployment-after-code-changes">Redeployment (After Code Changes)</h3>
<p><strong>For frontend changes:</strong></p>
<p>On Windows:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cd</span> <span class="st">&quot;path\to\labreportai\frontend&quot;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>docker build <span class="op">-</span>f Dockerfile<span class="op">.</span><span class="fu">prod</span> `</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>build<span class="op">-</span>arg NEXT_PUBLIC_API_URL<span class="op">=</span>https<span class="op">://</span>YOUR_DOMAIN<span class="op">.</span><span class="fu">duckdns</span><span class="op">.</span><span class="fu">org</span> `</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">--</span>build<span class="op">-</span>arg NEXT_PUBLIC_RECAPTCHA_SITE_KEY<span class="op">=</span>placeholder `</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>t labreportai<span class="op">-</span>frontend<span class="op">:</span>latest <span class="op">.</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>docker save labreportai<span class="op">-</span>frontend<span class="op">:</span>latest <span class="op">-</span>o frontend<span class="op">-</span>image<span class="op">.</span><span class="fu">tar</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>scp <span class="op">-</span>i <span class="st">&quot;path\to\ssh-key.key&quot;</span> frontend<span class="op">-</span>image<span class="op">.</span><span class="fu">tar</span> ubuntu@YOUR_SERVER_IP<span class="op">:~/</span></span></code></pre></div>
<p>On Server:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/labreportai</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> pull</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose <span class="at">-f</span> docker-compose.yml <span class="at">-f</span> docker-compose.prod.yml down</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> image rm labreportai-frontend:latest <span class="dv">2</span><span class="op">&gt;</span>/dev/null <span class="kw">||</span> <span class="fu">true</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> volume prune <span class="at">-f</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> load <span class="op">&lt;</span> ~/frontend-image.tar</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose <span class="at">-f</span> docker-compose.yml <span class="at">-f</span> docker-compose.prod.yml up <span class="at">-d</span></span></code></pre></div>
<p><strong>For backend-only changes:</strong></p>
<p>On Server:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/labreportai</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> pull</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> compose <span class="at">-f</span> docker-compose.yml <span class="at">-f</span> docker-compose.prod.yml up <span class="at">-d</span> <span class="at">--build</span> backend celery-worker celery-beat</span></code></pre></div>
<hr />
<h2 id="known-issues-fixes">17. Known Issues &amp; Fixes</h2>
<h3 id="react-hydration-error-418">React Hydration Error #418</h3>
<p><strong>Problem:</strong> After deploying Next.js 15 with React 19 in standalone mode, the page would show briefly with correct styling, then break with console error:</p>
<pre><code>Uncaught Error: Minified React error #418</code></pre>
<p>This error means â€œHydration failed because the initial UI does not match what was rendered on the server.â€</p>
<p><strong>Root Cause:</strong> Server-side rendered HTML differed from what React expected on the client during hydration. This can happen due to: - Browser extensions modifying DOM - Dynamic content rendered differently on server vs client - Whitespace differences in JSX - Next.js standalone build quirks with React 19</p>
<p><strong>Solution:</strong> Use the â€œmounted patternâ€ - render nothing until the component mounts on the client, guaranteeing no server/client mismatch.</p>
<p><strong>Fixed Code (frontend/src/app/page.tsx):</strong></p>
<pre class="tsx"><code>&quot;use client&quot;;

import { useState, useEffect } from &quot;react&quot;;
import UploadForm from &quot;@/components/UploadForm&quot;;

export default function HomePage() {
  const [mounted, setMounted] = useState(false);

  useEffect(() =&gt; {
    setMounted(true);
  }, []);

  // Return null until mounted - guarantees no hydration mismatch
  if (!mounted) {
    return null;
  }

  return (
    &lt;div className=&quot;space-y-6&quot;&gt;
      {/* Page content here */}
    &lt;/div&gt;
  );
}</code></pre>
<p><strong>Fixed Code (frontend/src/app/layout.tsx):</strong></p>
<pre class="tsx"><code>&lt;html lang=&quot;en&quot; suppressHydrationWarning&gt;
  &lt;body className=&quot;...&quot; suppressHydrationWarning&gt;
    {/* Layout content */}
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p><strong>Key Changes:</strong> 1. Add <code>"use client"</code> directive to page.tsx 2. Use <code>useState(false)</code> + <code>useEffect</code> to track mount state 3. Return <code>null</code> before mount (server and client both render nothing initially) 4. After hydration succeeds, <code>useEffect</code> runs, <code>mounted</code> becomes <code>true</code>, real content renders 5. Add <code>suppressHydrationWarning</code> to both <code>&lt;html&gt;</code> and <code>&lt;body&gt;</code> tags in layout.tsx 6. Remove explicit <code>&lt;head&gt;</code> tag from layout (Next.js manages it automatically)</p>
<h3 id="docker-volume-override-issue">Docker Volume Override Issue</h3>
<p><strong>Problem:</strong> Frontend container crashes with â€œMODULE_NOT_FOUNDâ€ for <code>/app/.next/standalone/server.js</code> even though the image was built correctly.</p>
<p><strong>Root Cause:</strong> Anonymous Docker volumes from base <code>docker-compose.yml</code> were mounting over the imageâ€™s files, replacing the built standalone output with empty directories.</p>
<p><strong>Solution:</strong> 1. In <code>docker-compose.prod.yml</code>, explicitly set <code>volumes: []</code> for frontend service 2. Before redeploying, prune volumes: <code>docker volume prune -f</code> 3. Remove and recreate containers completely (not just restart)</p>
<h3 id="caddy-ssl-certificate-timeout">Caddy SSL Certificate Timeout</h3>
<p><strong>Problem:</strong> Caddy fails to obtain SSL certificate with â€œTimeout during connect (likely firewall problem)â€.</p>
<p><strong>Root Cause:</strong> OCI Security List doesnâ€™t have ingress rules for ports 80 and 443.</p>
<p><strong>Solution:</strong> In OCI Console: 1. Go to Networking â†’ Virtual Cloud Networks â†’ Your VCN 2. Click on the public subnet 3. Click on the Security List 4. Add Ingress Rules: - Source: <code>0.0.0.0/0</code>, Protocol: TCP, Destination Port: 80 - Source: <code>0.0.0.0/0</code>, Protocol: TCP, Destination Port: 443</p>
<hr />
<h2 id="post-analysis-chat-feature-phase-8">18. Post-Analysis Chat Feature (Phase 8)</h2>
<h3 id="overview">Overview</h3>
<p>After a lab report is analyzed, users can interact with an AI chatbot to ask questions about their results. The chat provides personalized health insights based on the analysis, answering questions like â€œHow is my lipid profile?â€ or â€œHow can I improve my cholesterol with diet changes?â€</p>
<p><strong>Key Principles:</strong> - Educational only â€” no diagnosis or treatment recommendations - Context-aware â€” AI has full access to the analysis results - Rate-limited â€” prevents abuse while allowing meaningful conversations - Ephemeral â€” no chat history persistence (MVP)</p>
<hr />
<h3 id="user-experience">User Experience</h3>
<h4 id="chat-widget">Chat Widget</h4>
<ul>
<li><strong>Location</strong>: Two access points on the report results page:
<ol type="1">
<li><strong>Floating chat button</strong> (bottom-right corner) â€” circular blue button with chat icon</li>
<li><strong>â€œDiscuss Your Reportâ€ button</strong> â€” purple action button between â€œDownload PDF Reportâ€ and â€œUpload Another Reportâ€</li>
</ol></li>
<li><strong>Trigger</strong>: Both buttons appear only after report analysis is complete</li>
<li><strong>Initial State</strong>: Floating button visible; inline button in action bar</li>
<li><strong>Expanded State</strong>: Chat panel (550px Ã— 650px on desktop; almost full-screen with 8px margins on mobile)</li>
<li><strong>Close Behavior</strong>: Collapse to buttons; conversation preserved until page refresh</li>
</ul>
<h4 id="conversation-flow">Conversation Flow</h4>
<ol type="1">
<li>User clicks floating chat button</li>
<li>Chat panel expands showing:
<ul>
<li>Welcome message with context acknowledgment</li>
<li>3-4 starter question suggestions based on the report</li>
<li>Message input field</li>
<li>â€œX of 20 messages remainingâ€ indicator</li>
</ul></li>
<li>User types a question or clicks a suggestion</li>
<li>AI response streams in real-time (token by token)</li>
<li>After AI responds, 2-3 contextual follow-up suggestions appear</li>
<li>Conversation continues until user closes panel or exhausts message limit</li>
</ol>
<h4 id="message-limit-ux">Message Limit UX</h4>
<ul>
<li>Display: â€œX of 20 messages remainingâ€ at bottom of chat panel</li>
<li>Warning: When 5 messages remain, show subtle warning color</li>
<li>Final message: â€œYouâ€™ve used all 20 messages for this report. Download the PDF for a complete summary.â€</li>
<li>Counter only tracks user messages (not AI responses)</li>
</ul>
<hr />
<h3 id="starter-questions-initial-suggestions">Starter Questions (Initial Suggestions)</h3>
<p>Generated dynamically based on the analysis results. Examples:</p>
<p><strong>For a CBC report with low hemoglobin:</strong> - â€œWhat does my low hemoglobin mean?â€ - â€œHow can I improve my hemoglobin levels naturally?â€ - â€œShould I be concerned about my CBC results?â€</p>
<p><strong>For a lipid panel with high LDL:</strong> - â€œExplain my cholesterol resultsâ€ - â€œWhat dietary changes can help lower my LDL?â€ - â€œHow does my lipid profile affect heart health?â€</p>
<p><strong>For a thyroid panel:</strong> - â€œWhat do my thyroid results indicate?â€ - â€œHow does TSH relate to metabolism?â€ - â€œAre my T3 and T4 levels concerning?â€</p>
<p><strong>Generation Logic:</strong> - Extract categories with abnormal/critical values from analysis JSON - Generate 3-4 relevant questions per report - Prioritize critical values, then borderline, then normal summaries - Fall back to generic questions if analysis lacks detail</p>
<hr />
<h3 id="contextual-follow-up-suggestions">Contextual Follow-up Suggestions</h3>
<p>After each AI response, show 2-3 follow-up suggestions based on: - The topic of the previous question - Abnormal values not yet discussed - Natural conversation flow (e.g., after explaining a value â†’ suggest lifestyle changes)</p>
<p><strong>Example Flow:</strong> 1. User asks: â€œWhat does my high LDL mean?â€ 2. AI explains LDL cholesterol 3. Follow-ups appear: - â€œHow can I lower my LDL with diet?â€ - â€œWhat exercise helps reduce cholesterol?â€ - â€œTell me about my other lipid valuesâ€</p>
<hr />
<h3 id="api-specification">API Specification</h3>
<h4 id="endpoint-chat-message">Endpoint: Chat Message</h4>
<pre><code>POST /v1/chat/{job_id}</code></pre>
<p><strong>Request Body:</strong></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="st">&quot;What does my low hemoglobin mean?&quot;</span><span class="fu">,</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;conversation_history&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span><span class="dt">&quot;role&quot;</span><span class="fu">:</span> <span class="st">&quot;user&quot;</span><span class="fu">,</span> <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="st">&quot;Previous question...&quot;</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span><span class="dt">&quot;role&quot;</span><span class="fu">:</span> <span class="st">&quot;assistant&quot;</span><span class="fu">,</span> <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="st">&quot;Previous answer...&quot;</span><span class="fu">}</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Response:</strong> Server-Sent Events (SSE) stream</p>
<pre><code>event: token
data: {&quot;content&quot;: &quot;Low &quot;}

event: token
data: {&quot;content&quot;: &quot;hemoglobin &quot;}

event: token
data: {&quot;content&quot;: &quot;indicates...&quot;}

event: done
data: {&quot;suggestions&quot;: [&quot;How can I improve my hemoglobin?&quot;, &quot;What foods are rich in iron?&quot;], &quot;messages_remaining&quot;: 18}

event: error
data: {&quot;message&quot;: &quot;Rate limit exceeded for this report&quot;}</code></pre>
<p><strong>Headers:</strong></p>
<pre><code>Content-Type: text/event-stream
Cache-Control: no-cache
Connection: keep-alive</code></pre>
<h4 id="endpoint-get-starter-questions">Endpoint: Get Starter Questions</h4>
<pre><code>GET /v1/chat/{job_id}/suggestions</code></pre>
<p><strong>Response:</strong></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;suggestions&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;What does my low hemoglobin mean?&quot;</span><span class="ot">,</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;How is my lipid profile overall?&quot;</span><span class="ot">,</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Should I be concerned about any values?&quot;</span><span class="ot">,</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;What lifestyle changes do you recommend?&quot;</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;messages_remaining&quot;</span><span class="fu">:</span> <span class="dv">20</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="error-responses">Error Responses</h4>
<table>
<thead>
<tr class="header">
<th>Status</th>
<th>Code</th>
<th>Message</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>404</td>
<td>REPORT_NOT_FOUND</td>
<td>Report not found or expired</td>
</tr>
<tr class="even">
<td>400</td>
<td>REPORT_NOT_READY</td>
<td>Report analysis not yet complete</td>
</tr>
<tr class="odd">
<td>429</td>
<td>CHAT_LIMIT_EXCEEDED</td>
<td>Message limit (20) reached for this report</td>
</tr>
<tr class="even">
<td>400</td>
<td>MESSAGE_TOO_LONG</td>
<td>Message exceeds 500 character limit</td>
</tr>
<tr class="odd">
<td>503</td>
<td>LLM_UNAVAILABLE</td>
<td>Chat service temporarily unavailable</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="backend-implementation">Backend Implementation</h3>
<h4 id="chat-service-backendappserviceschat.py">Chat Service (<code>backend/app/services/chat.py</code>)</h4>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ChatService:</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, analysis_json: <span class="bu">dict</span>, job_id: <span class="bu">str</span>):</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.analysis <span class="op">=</span> analysis_json</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.job_id <span class="op">=</span> job_id</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.llm <span class="op">=</span> get_chat_llm()  <span class="co"># Configurable, default 8B model</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> generate_response(</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        message: <span class="bu">str</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        history: <span class="bu">list</span>[<span class="bu">dict</span>]</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> AsyncGenerator[<span class="bu">str</span>, <span class="va">None</span>]:</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Stream chat response tokens.&quot;&quot;&quot;</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        prompt <span class="op">=</span> <span class="va">self</span>._build_prompt(message, history)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">async</span> <span class="cf">for</span> token <span class="kw">in</span> <span class="va">self</span>.llm.astream(prompt):</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> token</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate_suggestions(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">list</span>[<span class="bu">str</span>]:</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Generate starter questions from analysis.&quot;&quot;&quot;</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract abnormal values, generate relevant questions</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate_followups(<span class="va">self</span>, last_response: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">list</span>[<span class="bu">str</span>]:</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Generate contextual follow-up suggestions.&quot;&quot;&quot;</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div>
<h4 id="chat-prompt-template-backendpromptschat.txt">Chat Prompt Template (<code>backend/prompts/chat.txt</code>)</h4>
<pre><code>You are a friendly health education assistant helping a user understand their lab report results.

CONTEXT - Analysis Results:
{analysis_json}

RULES:
1. You are NOT a doctor. Never diagnose or prescribe treatment.
2. Provide educational information only.
3. Reference specific values from the user&#39;s report when relevant.
4. Suggest lifestyle changes when appropriate (diet, exercise, sleep).
5. Recommend consulting a doctor for concerning values.
6. Keep responses concise (2-3 paragraphs max).
7. Use simple language; explain medical terms.
8. Be encouraging and supportive.
9. If asked about topics outside the lab report, politely redirect to health topics.

MANDATORY DISCLAIMER (include at end of responses about concerning values):
&quot;This is educational information only. Please consult your healthcare provider for personalized medical advice.&quot;

CONVERSATION HISTORY:
{history}

USER QUESTION:
{message}

Respond helpfully:</code></pre>
<h4 id="rate-limiting">Rate Limiting</h4>
<p>Track message count per report in Redis:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Redis key: chat_count:{job_id}</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Value: integer (0-20)</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># TTL: Same as report retention (48 hours)</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> check_chat_limit(job_id: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>[<span class="bu">bool</span>, <span class="bu">int</span>]:</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Check if user can send more messages. Returns (allowed, remaining).&quot;&quot;&quot;</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> <span class="ss">f&quot;chat_count:</span><span class="sc">{</span>job_id<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> <span class="cf">await</span> redis.get(key) <span class="kw">or</span> <span class="dv">0</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    remaining <span class="op">=</span> <span class="dv">20</span> <span class="op">-</span> <span class="bu">int</span>(count)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> remaining <span class="op">&gt;</span> <span class="dv">0</span>, remaining</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> increment_chat_count(job_id: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Increment message count, return remaining.&quot;&quot;&quot;</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> <span class="ss">f&quot;chat_count:</span><span class="sc">{</span>job_id<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    count <span class="op">=</span> <span class="cf">await</span> redis.incr(key)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> count <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Set TTL on first message</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> redis.expire(key, <span class="dv">48</span> <span class="op">*</span> <span class="dv">60</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">20</span> <span class="op">-</span> count</span></code></pre></div>
<hr />
<h3 id="frontend-implementation">Frontend Implementation</h3>
<h4 id="components">Components</h4>
<table>
<colgroup>
<col style="width: 55%" />
<col style="width: 45%" />
</colgroup>
<thead>
<tr class="header">
<th>Component</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>ChatWidget.tsx</code></td>
<td>Complete chat component with floating button, expandable panel, messages, input, and suggestions. Exposes <code>open()</code> method via <code>forwardRef</code> for external triggering.</td>
</tr>
</tbody>
</table>
<p><strong>Note:</strong> The chat is implemented as a single <code>ChatWidget</code> component rather than separate components. It includes: - Floating circular button (bottom-right) - Expandable chat panel (550Ã—650px desktop, near full-screen mobile) - Message bubbles for user and AI - Suggestion chips for starter and follow-up questions - Text input with send button and remaining message counter</p>
<p>The widget can be opened via: 1. Clicking the floating button 2. Clicking the â€œDiscuss Your Reportâ€ button (calls <code>chatWidgetRef.current.open()</code>)</p>
<h4 id="state-management">State Management</h4>
<div class="sourceCode" id="cb27"><pre class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>interface ChatState {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  isOpen<span class="op">:</span> <span class="dt">boolean</span><span class="op">;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  messages<span class="op">:</span> ChatMessage[]<span class="op">;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  isStreaming<span class="op">:</span> <span class="dt">boolean</span><span class="op">;</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  currentStreamedResponse<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  suggestions<span class="op">:</span> <span class="dt">string</span>[]<span class="op">;</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  messagesRemaining<span class="op">:</span> <span class="dt">number</span><span class="op">;</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  error<span class="op">:</span> <span class="dt">string</span> <span class="op">|</span> <span class="dt">null</span><span class="op">;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>interface ChatMessage {</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  role<span class="op">:</span> <span class="st">&quot;user&quot;</span> <span class="op">|</span> <span class="st">&quot;assistant&quot;</span><span class="op">;</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  content<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  timestamp<span class="op">:</span> Date<span class="op">;</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h4 id="streaming-handler">Streaming Handler</h4>
<div class="sourceCode" id="cb28"><pre class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>async <span class="kw">function</span> <span class="fu">sendMessage</span>(message<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setIsStreaming</span>(true)<span class="op">;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setCurrentStreamedResponse</span>(<span class="st">&quot;&quot;</span>)<span class="op">;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  const response <span class="op">=</span> await <span class="fu">fetch</span>(<span class="vs">`/v1/chat/</span><span class="sc">${</span>jobId<span class="sc">}</span><span class="vs">`</span><span class="op">,</span> {</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    method<span class="op">:</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">:</span> { <span class="st">&quot;Content-Type&quot;</span><span class="op">:</span> <span class="st">&quot;application/json&quot;</span> }<span class="op">,</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    body<span class="op">:</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>({ message<span class="op">,</span> conversation_history<span class="op">:</span> messages })<span class="op">,</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  const reader <span class="op">=</span> response<span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">getReader</span>()<span class="op">;</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  const decoder <span class="op">=</span> <span class="kw">new</span> <span class="fu">TextDecoder</span>()<span class="op">;</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">while</span> (true) {</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    const { done<span class="op">,</span> value } <span class="op">=</span> await reader<span class="op">.</span><span class="fu">read</span>()<span class="op">;</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">if</span> (done) break<span class="op">;</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    const chunk <span class="op">=</span> decoder<span class="op">.</span><span class="fu">decode</span>(value)<span class="op">;</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    const lines <span class="op">=</span> chunk<span class="op">.</span><span class="fu">split</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)<span class="op">;</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">for</span> (const line of lines) {</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">if</span> (line<span class="op">.</span><span class="fu">startsWith</span>(<span class="st">&quot;data: &quot;</span>)) {</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>        const data <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(line<span class="op">.</span><span class="fu">slice</span>(<span class="dv">6</span>))<span class="op">;</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">if</span> (data<span class="op">.</span><span class="at">content</span>) {</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">setCurrentStreamedResponse</span>(prev <span class="kw">=&gt;</span> prev <span class="op">+</span> data<span class="op">.</span><span class="at">content</span>)<span class="op">;</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">if</span> (data<span class="op">.</span><span class="at">suggestions</span>) {</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>          <span class="fu">setSuggestions</span>(data<span class="op">.</span><span class="at">suggestions</span>)<span class="op">;</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>          <span class="fu">setMessagesRemaining</span>(data<span class="op">.</span><span class="at">messages_remaining</span>)<span class="op">;</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Finalize message</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setMessages</span>(prev <span class="kw">=&gt;</span> [<span class="op">...</span>prev<span class="op">,</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    { role<span class="op">:</span> <span class="st">&quot;user&quot;</span><span class="op">,</span> content<span class="op">:</span> message }<span class="op">,</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    { role<span class="op">:</span> <span class="st">&quot;assistant&quot;</span><span class="op">,</span> content<span class="op">:</span> currentStreamedResponse }</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>  ])<span class="op">;</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setIsStreaming</span>(false)<span class="op">;</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<hr />
<h3 id="configuration-options-1">Configuration Options</h3>
<table>
<thead>
<tr class="header">
<th>Option</th>
<th>Default</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>CHAT_ENABLED</code></td>
<td>true</td>
<td>Enable/disable chat feature</td>
</tr>
<tr class="even">
<td><code>CHAT_MESSAGE_LIMIT</code></td>
<td>20</td>
<td>Max messages per report</td>
</tr>
<tr class="odd">
<td><code>CHAT_MAX_MESSAGE_LENGTH</code></td>
<td>500</td>
<td>Max characters per user message</td>
</tr>
<tr class="even">
<td><code>LLM_CHAT_MODEL</code></td>
<td>(validation model)</td>
<td>LLM for chat (configurable, default 8B)</td>
</tr>
<tr class="odd">
<td><code>CHAT_RESPONSE_MAX_TOKENS</code></td>
<td>500</td>
<td>Max tokens per AI response</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="database-changes">Database Changes</h3>
<p>No new tables required. Chat state is ephemeral: - Message count stored in Redis (<code>chat_count:{job_id}</code>) - Conversation history passed in each request (stateless backend) - Chat history not persisted (MVP decision)</p>
<hr />
<h3 id="files-to-createmodify">Files to Create/Modify</h3>
<h4 id="new-files">New Files</h4>
<table>
<colgroup>
<col style="width: 40%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="header">
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>backend/app/api/v1/chat.py</code></td>
<td>Chat API endpoints (SSE streaming + suggestions)</td>
</tr>
<tr class="even">
<td><code>backend/app/services/chat.py</code></td>
<td>Chat service with LLM integration and rate limiting</td>
</tr>
<tr class="odd">
<td><code>backend/app/schemas/chat.py</code></td>
<td>Pydantic schemas for chat requests/responses</td>
</tr>
<tr class="even">
<td><code>backend/prompts/chat.txt</code></td>
<td>Chat system prompt</td>
</tr>
<tr class="odd">
<td><code>frontend/src/components/ChatWidget.tsx</code></td>
<td>Complete chat widget (floating button + panel + messages + input)</td>
</tr>
<tr class="even">
<td><code>frontend/src/lib/chat.ts</code></td>
<td>Chat API client with SSE handling</td>
</tr>
</tbody>
</table>
<h4 id="modified-files">Modified Files</h4>
<table>
<colgroup>
<col style="width: 40%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="header">
<th>File</th>
<th>Changes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>backend/app/api/router.py</code></td>
<td>Register chat routes</td>
</tr>
<tr class="even">
<td><code>backend/app/config.py</code></td>
<td>Add chat configuration options (llm_chat_model, chat_enabled, chat_message_limit, etc.)</td>
</tr>
<tr class="odd">
<td><code>backend/app/services/llm_provider.py</code></td>
<td>Add <code>get_chat_llm()</code> factory function</td>
</tr>
<tr class="even">
<td><code>frontend/src/components/ReportView.tsx</code></td>
<td>Add ChatWidget with ref, add purple â€œDiscuss Your Reportâ€ button</td>
</tr>
<tr class="odd">
<td><code>frontend/src/types/index.ts</code></td>
<td>Add chat-related types (ChatMessage, ChatStreamDoneEvent, etc.)</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="acceptance-criteria">Acceptance Criteria</h3>
<ol type="1">
<li>âœ… Floating chat button appears on completed report page</li>
<li>âœ… Chat panel opens/closes smoothly with animation</li>
<li>âœ… Starter questions generated based on report content</li>
<li>âœ… AI responses stream in real-time (visible token-by-token)</li>
<li>âœ… Follow-up suggestions appear after each AI response</li>
<li>âœ… Message counter shows â€œX of 20 messages remainingâ€</li>
<li>âœ… Chat blocked after 20 messages with clear message</li>
<li>âœ… 404 returned for expired/non-existent reports</li>
<li>âœ… Mandatory disclaimer on health-related responses</li>
<li>âœ… Chat works on mobile (responsive design)</li>
<li>âœ… Chat only discusses health topics; redirects off-topic questions</li>
<li>âœ… Streaming gracefully handles connection interruptions</li>
</ol>
<hr />
<h3 id="out-of-scope-future-enhancements">Out of Scope (Future Enhancements)</h3>
<ul>
<li>Chat history persistence across sessions</li>
<li>Urdu language support for chat</li>
<li>Voice input/output</li>
<li>Export chat transcript</li>
<li>WhatsApp chat integration</li>
<li>Multi-report context (compare with previous results)</li>
<li>Saved/favorite responses</li>
</ul>
<hr />
<h2 id="medical-imaging-analysis-future---phase-9">19. Medical Imaging Analysis (Future - Phase 9)</h2>
<h3 id="overview-1">Overview</h3>
<p>Extend LabReportAI to analyze medical imaging (ultrasound, X-ray, MRI, CT scans) using LLM vision APIs. This leverages existing LLM infrastructure rather than deploying specialized ML models, keeping memory usage low for resource-constrained servers.</p>
<h3 id="architecture-approach">Architecture Approach</h3>
<pre><code>Current:  Image â†’ OCR â†’ Text â†’ LLM Text Analysis â†’ Results
New:      Image â†’ Detect Type â†’ Branch:
          â”œâ”€ Lab Report â†’ OCR â†’ Text Analysis (existing)
          â””â”€ Medical Image â†’ Vision LLM â†’ Image Analysis (new)</code></pre>
<h3 id="scope-decisions">Scope Decisions</h3>
<ul>
<li><strong>Imaging Types:</strong> All (X-ray, Ultrasound, MRI, CT) from the start</li>
<li><strong>File Formats:</strong> Standard images only (PNG, JPG) - no DICOM initially</li>
<li><strong>LLM Provider:</strong> Configurable via .env (like existing text analysis)</li>
</ul>
<hr />
<h3 id="new-files-to-create">New Files to Create</h3>
<table>
<colgroup>
<col style="width: 40%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="header">
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>backend/app/services/vision_analyzer.py</code></td>
<td>Analyze images via LLM vision API</td>
</tr>
<tr class="even">
<td><code>backend/app/services/imaging_validator.py</code></td>
<td>Detect if image is medical imaging</td>
</tr>
<tr class="odd">
<td><code>backend/app/services/image_preprocessor.py</code></td>
<td>Resize/encode images for API</td>
</tr>
<tr class="even">
<td><code>backend/prompts/imaging_classification.txt</code></td>
<td>Prompt for modality detection</td>
</tr>
<tr class="odd">
<td><code>backend/prompts/imaging_analysis.txt</code></td>
<td>Prompt for medical image analysis</td>
</tr>
<tr class="even">
<td><code>templates/pdf/imaging_report.html</code></td>
<td>PDF template for imaging reports</td>
</tr>
</tbody>
</table>
<h3 id="files-to-modify">Files to Modify</h3>
<table>
<colgroup>
<col style="width: 40%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="header">
<th>File</th>
<th>Changes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>backend/app/models/report.py</code></td>
<td>Add <code>report_type</code>, <code>imaging_modality</code>, <code>body_region</code> columns</td>
</tr>
<tr class="even">
<td><code>backend/app/tasks/analyze.py</code></td>
<td>Add branching logic: lab report vs imaging</td>
</tr>
<tr class="odd">
<td><code>backend/app/services/llm_provider.py</code></td>
<td>Add <code>get_vision_llm()</code> for vision-capable models</td>
</tr>
<tr class="even">
<td><code>backend/app/config.py</code></td>
<td>Add <code>llm_vision_model</code>, <code>max_image_dimension</code> settings</td>
</tr>
<tr class="odd">
<td><code>backend/app/services/markdown_renderer.py</code></td>
<td>Add <code>render_imaging_markdown()</code> function</td>
</tr>
<tr class="even">
<td><code>backend/app/services/pdf_generator.py</code></td>
<td>Add <code>generate_imaging_pdf()</code> function</td>
</tr>
<tr class="odd">
<td><code>frontend/src/components/UploadForm.tsx</code></td>
<td>Add report type selector (auto/lab/imaging)</td>
</tr>
<tr class="even">
<td><code>frontend/src/types/index.ts</code></td>
<td>Add imaging-related types</td>
</tr>
</tbody>
</table>
<h3 id="database-migration">Database Migration</h3>
<div class="sourceCode" id="cb30"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> reports <span class="kw">ADD</span> <span class="kw">COLUMN</span> report_type ENUM(<span class="st">&#39;lab_report&#39;</span>, <span class="st">&#39;imaging&#39;</span>) <span class="kw">DEFAULT</span> <span class="st">&#39;lab_report&#39;</span>;</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> reports <span class="kw">ADD</span> <span class="kw">COLUMN</span> imaging_modality <span class="dt">VARCHAR</span>(<span class="dv">50</span>);</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">ALTER</span> <span class="kw">TABLE</span> reports <span class="kw">ADD</span> <span class="kw">COLUMN</span> imaging_body_region <span class="dt">VARCHAR</span>(<span class="dv">100</span>);</span></code></pre></div>
<h3 id="configuration-.env">Configuration (.env)</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Vision LLM settings (configurable like existing text analysis)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="va">LLM_VISION_PROVIDER</span><span class="op">=</span>groq          <span class="co"># groq, openai, google, anthropic</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="va">LLM_VISION_MODEL</span><span class="op">=</span>llama-3.2-90b-vision-preview  <span class="co"># or gpt-4o, gemini-pro-vision, claude-3-5-sonnet</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="va">LLM_VISION_VALIDATION_MODEL</span><span class="op">=</span>      <span class="co"># Cheaper model for classification (optional)</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="va">MAX_IMAGE_DIMENSION</span><span class="op">=</span>1024          <span class="co"># Resize larger images for API efficiency</span></span></code></pre></div>
<h3 id="output-structure-for-imaging">Output Structure for Imaging</h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;study_info&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="dt">&quot;modality&quot;</span><span class="fu">:</span> <span class="st">&quot;xray&quot;</span><span class="fu">,</span> <span class="dt">&quot;body_region&quot;</span><span class="fu">:</span> <span class="st">&quot;chest&quot;</span><span class="fu">,</span> <span class="dt">&quot;view&quot;</span><span class="fu">:</span> <span class="st">&quot;PA&quot;</span> <span class="fu">},</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;findings&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span> <span class="dt">&quot;structure&quot;</span><span class="fu">:</span> <span class="st">&quot;...&quot;</span><span class="fu">,</span> <span class="dt">&quot;observation&quot;</span><span class="fu">:</span> <span class="st">&quot;...&quot;</span><span class="fu">,</span> <span class="dt">&quot;severity&quot;</span><span class="fu">:</span> <span class="st">&quot;normal|mild|moderate|severe&quot;</span> <span class="fu">}</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;measurements&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;impression&quot;</span><span class="fu">:</span> <span class="st">&quot;Summary&quot;</span><span class="fu">,</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;recommendations&quot;</span><span class="fu">:</span> <span class="st">&quot;Follow-up suggestions&quot;</span><span class="fu">,</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;disclaimer&quot;</span><span class="fu">:</span> <span class="st">&quot;Educational only&quot;</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 id="cost-estimation-per-image">Cost Estimation (Per Image)</h3>
<table>
<thead>
<tr class="header">
<th>Provider</th>
<th>Model</th>
<th>Cost</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Groq</td>
<td>llama-3.2-90b-vision</td>
<td>Free tier available</td>
</tr>
<tr class="even">
<td>OpenAI</td>
<td>gpt-4o-mini (validation)</td>
<td>~$0.002</td>
</tr>
<tr class="odd">
<td>OpenAI</td>
<td>gpt-4o (analysis)</td>
<td>~$0.02-0.05</td>
</tr>
<tr class="even">
<td>Anthropic</td>
<td>claude-3-5-sonnet</td>
<td>~$0.03-0.08</td>
</tr>
</tbody>
</table>
<h3 id="implementation-sequence">Implementation Sequence</h3>
<ol type="1">
<li><strong>Backend Core</strong> - Database migration, vision_analyzer.py service, imaging prompts</li>
<li><strong>Pipeline Integration</strong> - Modify analyze.py with branching, imaging markdown/PDF templates</li>
<li><strong>Frontend</strong> - Report type selector in upload form, imaging-specific results display</li>
<li><strong>Testing</strong> - Test with sample X-ray/ultrasound/MRI/CT images</li>
</ol>
<h3 id="future-dicom-support-phase-10">Future: DICOM Support (Phase 10)</h3>
<ul>
<li>Add <code>pydicom</code> dependency for DICOM file parsing</li>
<li>Extract metadata from DICOM headers</li>
<li>Handle multi-slice 3D volumes (MRI, CT)</li>
<li>Select key slices for analysis</li>
</ul>
<hr />
<h2 id="website-branding-ui">20. Website Branding &amp; UI</h2>
<h3 id="header">Header</h3>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Element</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Logo</strong></td>
<td><code>frontend/public/logo.png</code> - LabReportAI logo with clipboard/brain icon</td>
</tr>
<tr class="even">
<td><strong>Logo Size</strong></td>
<td>Desktop: 96px height, Mobile: 64px height</td>
</tr>
<tr class="odd">
<td><strong>Position</strong></td>
<td>Left side of header, links to homepage</td>
</tr>
<tr class="even">
<td><strong>Tagline</strong></td>
<td>â€œEducational Insights Onlyâ€ - right side of header</td>
</tr>
</tbody>
</table>
<h3 id="footer">Footer</h3>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Element</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Disclaimer</strong></td>
<td>â€œThis tool provides educational insights only. It is not a diagnosis or treatment recommendation.â€</td>
</tr>
<tr class="even">
<td><strong>Credit</strong></td>
<td>â€œDeveloped by QueryVersityâ€ with mailto link to queryversity@gmail.com</td>
</tr>
</tbody>
</table>
<h3 id="favicon">Favicon</h3>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Element</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>File</strong></td>
<td><code>frontend/src/app/icon.png</code> - Next.js auto-detects this for browser tab icon</td>
</tr>
<tr class="even">
<td><strong>Source</strong></td>
<td><code>images/favicon.png</code></td>
</tr>
</tbody>
</table>
<h3 id="action-button-animation">Action Button Animation</h3>
<p>The â€œDiscuss Your Reportâ€ button features an attention-grabbing pulse animation:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode css"><code class="sourceCode css"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">@keyframes</span> attention-pulse {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0%</span>, <span class="dv">100%</span> {</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">box-shadow</span>: <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="dv">0</span> <span class="fu">rgba(</span><span class="dv">147</span><span class="op">,</span> <span class="dv">51</span><span class="op">,</span> <span class="dv">234</span><span class="op">,</span> <span class="dv">0.7</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">transform</span>: <span class="fu">scale(</span><span class="dv">1</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="dv">50%</span> {</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">box-shadow</span>: <span class="dv">0</span> <span class="dv">0</span> <span class="dv">20</span><span class="dt">px</span> <span class="dv">10</span><span class="dt">px</span> <span class="fu">rgba(</span><span class="dv">147</span><span class="op">,</span> <span class="dv">51</span><span class="op">,</span> <span class="dv">234</span><span class="op">,</span> <span class="dv">0</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">transform</span>: <span class="fu">scale(</span><span class="dv">1.02</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="fu">.animate-attention-pulse</span> {</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">animation</span>: attention-pulse <span class="dv">1.5</span><span class="dt">s</span> <span class="dv">ease-in-out</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<ul>
<li><strong>Purpose:</strong> Draw user attention to the chat feature after report completion</li>
<li><strong>Duration:</strong> 1.5 seconds per cycle, runs 3 times then stops</li>
<li><strong>Effect:</strong> Purple glow expanding outward with slight scale-up</li>
</ul>
<h3 id="files">Files</h3>
<table>
<thead>
<tr class="header">
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>frontend/src/app/layout.tsx</code></td>
<td>Header with logo, footer with credit</td>
</tr>
<tr class="even">
<td><code>frontend/src/app/globals.css</code></td>
<td>Pulse animation CSS</td>
</tr>
<tr class="odd">
<td><code>frontend/public/logo.png</code></td>
<td>Logo image file</td>
</tr>
<tr class="even">
<td><code>frontend/src/app/icon.png</code></td>
<td>Favicon (auto-detected by Next.js)</td>
</tr>
<tr class="odd">
<td><code>images/logo.png</code></td>
<td>Source logo file</td>
</tr>
<tr class="even">
<td><code>images/favicon.png</code></td>
<td>Source favicon file</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>
