<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Report AI â€“ Specification v2.1</title>
    <style>
        :root {
            --primary: #1a56db;
            --primary-light: #e8effc;
            --accent: #7c3aed;
            --accent-light: #f3eefe;
            --success: #059669;
            --success-light: #ecfdf5;
            --warning: #d97706;
            --warning-light: #fffbeb;
            --danger: #dc2626;
            --danger-light: #fef2f2;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
            --radius: 12px;
            --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #1a56db 50%, #7c3aed 100%);
            color: white;
            padding: 48px 0 40px;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
            border-radius: 50%;
        }
        .header-inner {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 32px;
            position: relative;
        }
        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        .header .subtitle {
            font-size: 1.05rem;
            opacity: 0.85;
            font-weight: 400;
        }
        .version-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 12px;
            backdrop-filter: blur(4px);
        }

        /* Navigation */
        .nav {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }
        .nav-inner {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 32px;
            display: flex;
            gap: 0;
            overflow-x: auto;
        }
        .nav a {
            display: block;
            padding: 14px 18px;
            text-decoration: none;
            color: var(--gray-500);
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .nav a:hover {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--primary-light);
        }

        /* Main content */
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 32px;
        }

        /* Section cards */
        .section {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            overflow: hidden;
        }
        .section-header {
            padding: 20px 28px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .section-header .num {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        .section-header h2 {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--gray-900);
        }
        .section-body {
            padding: 24px 28px;
        }

        /* Lists */
        .goal-list, .non-goal-list {
            list-style: none;
            display: grid;
            gap: 10px;
        }
        .goal-list li, .non-goal-list li {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.92rem;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .goal-list li {
            background: var(--success-light);
            border-left: 3px solid var(--success);
        }
        .goal-list li::before {
            content: '\2713';
            color: var(--success);
            font-weight: 700;
            flex-shrink: 0;
        }
        .non-goal-list li {
            background: var(--gray-100);
            border-left: 3px solid var(--gray-300);
            color: var(--gray-700);
        }
        .non-goal-list li::before {
            content: '\2717';
            color: var(--gray-500);
            font-weight: 700;
            flex-shrink: 0;
        }

        /* Two columns */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        @media (max-width: 768px) {
            .two-col { grid-template-columns: 1fr; }
        }

        /* Sub-section labels */
        .sub-label {
            display: inline-block;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 3px 10px;
            border-radius: 4px;
            margin-bottom: 12px;
        }
        .sub-label.blue { background: var(--primary-light); color: var(--primary); }
        .sub-label.green { background: var(--success-light); color: var(--success); }
        .sub-label.purple { background: var(--accent-light); color: var(--accent); }
        .sub-label.orange { background: var(--warning-light); color: var(--warning); }
        .sub-label.red { background: var(--danger-light); color: var(--danger); }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        thead th {
            background: var(--gray-100);
            padding: 10px 14px;
            text-align: left;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-200);
        }
        tbody td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: top;
        }
        tbody tr:hover {
            background: var(--gray-50);
        }
        code {
            background: var(--gray-100);
            padding: 2px 7px;
            border-radius: 4px;
            font-size: 0.85em;
            font-family: 'SF Mono', 'Fira Code', monospace;
            color: var(--accent);
        }

        /* Tech stack badges */
        .tech-stack {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .tech-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.82rem;
            font-weight: 600;
            border: 1px solid;
        }
        .tech-badge.backend { background: #dbeafe; color: #1e40af; border-color: #93c5fd; }
        .tech-badge.frontend { background: #fce7f3; color: #9d174d; border-color: #f9a8d4; }
        .tech-badge.infra { background: #d1fae5; color: #065f46; border-color: #6ee7b7; }
        .tech-badge.ai { background: #ede9fe; color: #5b21b6; border-color: #c4b5fd; }
        .tech-badge.storage { background: #fef3c7; color: #92400e; border-color: #fcd34d; }

        /* Flow diagram */
        .flow {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin: 16px 0;
        }
        .flow-step {
            display: flex;
            align-items: stretch;
            gap: 16px;
        }
        .flow-line {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 36px;
            flex-shrink: 0;
        }
        .flow-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            border: 3px solid var(--primary-light);
            flex-shrink: 0;
            margin-top: 14px;
        }
        .flow-connector {
            width: 2px;
            flex: 1;
            background: var(--gray-200);
            min-height: 8px;
        }
        .flow-content {
            flex: 1;
            padding: 10px 16px;
            margin-bottom: 4px;
            border-radius: 8px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            font-size: 0.9rem;
        }
        .flow-content strong {
            color: var(--primary);
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .flow-content p {
            margin-top: 2px;
            color: var(--gray-700);
        }

        /* Config table */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        @media (max-width: 768px) {
            .config-grid { grid-template-columns: 1fr; }
        }
        .config-item {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 14px 16px;
        }
        .config-item .key {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 0.82rem;
            color: var(--accent);
            font-weight: 600;
        }
        .config-item .val {
            font-size: 0.85rem;
            color: var(--gray-700);
            margin-top: 2px;
        }
        .config-item .desc {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-top: 4px;
        }

        /* Callouts */
        .callout {
            padding: 16px 20px;
            border-radius: 8px;
            margin: 16px 0;
            font-size: 0.9rem;
            border-left: 4px solid;
        }
        .callout.info {
            background: var(--primary-light);
            border-color: var(--primary);
            color: #1e3a5f;
        }
        .callout.warn {
            background: var(--warning-light);
            border-color: var(--warning);
            color: #78350f;
        }
        .callout.danger {
            background: var(--danger-light);
            border-color: var(--danger);
            color: #7f1d1d;
        }
        .callout.success {
            background: var(--success-light);
            border-color: var(--success);
            color: #064e3b;
        }
        .callout strong {
            display: block;
            margin-bottom: 4px;
        }

        /* Disclaimer box */
        .disclaimer-box {
            background: #fef2f2;
            border: 2px solid #fca5a5;
            border-radius: var(--radius);
            padding: 20px 24px;
            margin: 16px 0;
            text-align: center;
        }
        .disclaimer-box .icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        .disclaimer-box blockquote {
            font-style: italic;
            color: #991b1b;
            font-size: 0.92rem;
            line-height: 1.6;
        }

        /* Color indicator demo */
        .color-demo {
            display: flex;
            gap: 16px;
            margin: 12px 0;
        }
        .color-demo .chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .chip.green-chip { background: #d1fae5; color: #065f46; }
        .chip.yellow-chip { background: #fef3c7; color: #92400e; }
        .chip.red-chip { background: #fee2e2; color: #991b1b; }
        .chip .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .chip.green-chip .dot { background: #059669; }
        .chip.yellow-chip .dot { background: #d97706; }
        .chip.red-chip .dot { background: #dc2626; }

        /* Architecture diagram */
        .arch-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 16px 0;
        }
        @media (max-width: 768px) {
            .arch-grid { grid-template-columns: 1fr; }
        }
        .arch-box {
            border: 2px solid;
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
        }
        .arch-box h4 {
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        .arch-box ul {
            list-style: none;
            font-size: 0.82rem;
            color: var(--gray-700);
        }
        .arch-box ul li {
            padding: 3px 0;
        }
        .arch-box.fe { border-color: #f9a8d4; background: #fdf2f8; }
        .arch-box.fe h4 { color: #9d174d; }
        .arch-box.be { border-color: #93c5fd; background: #eff6ff; }
        .arch-box.be h4 { color: #1e40af; }
        .arch-box.data { border-color: #6ee7b7; background: #ecfdf5; }
        .arch-box.data h4 { color: #065f46; }
        .arch-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--gray-300);
        }

        /* Output sections preview */
        .output-preview {
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            overflow: hidden;
            margin: 12px 0;
        }
        .output-section {
            padding: 10px 16px;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .output-section:last-child { border-bottom: none; }
        .output-section .order {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .output-section .name { font-weight: 600; }
        .output-section .detail { color: var(--gray-500); margin-left: auto; font-size: 0.8rem; }

        /* Checklist */
        .checklist {
            list-style: none;
            display: grid;
            gap: 8px;
        }
        .checklist li {
            padding: 10px 14px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.88rem;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .checklist li .check {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-300);
            border-radius: 4px;
            flex-shrink: 0;
            margin-top: 1px;
        }

        h3 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 12px;
            margin-top: 20px;
        }
        h3:first-child { margin-top: 0; }
        p { margin-bottom: 10px; font-size: 0.92rem; color: var(--gray-700); }
        p:last-child { margin-bottom: 0; }

        .divider {
            height: 1px;
            background: var(--gray-200);
            margin: 20px 0;
        }

        /* Decision badges */
        .decision {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.78rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            vertical-align: middle;
            margin-left: 6px;
        }
        .decision.confirmed { background: #d1fae5; color: #065f46; }
        .decision.pending { background: #fef3c7; color: #92400e; }

        .footer {
            text-align: center;
            padding: 32px;
            color: var(--gray-500);
            font-size: 0.82rem;
        }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="header-inner">
        <h1>Lab Report AI Interpretation API</h1>
        <p class="subtitle">Educational Lab Report Analysis System &mdash; Full-Stack Monorepo</p>
        <span class="version-badge">SPECIFICATION v2.1 &middot; UPDATED WITH Q&amp;A DECISIONS</span>
    </div>
</div>

<!-- NAV -->
<nav class="nav">
    <div class="nav-inner">
        <a href="#intent">Intent</a>
        <a href="#architecture">Architecture</a>
        <a href="#success">Success Criteria</a>
        <a href="#io">Inputs / Outputs</a>
        <a href="#workflow">Workflow</a>
        <a href="#output-format">Output Format</a>
        <a href="#config">Configuration</a>
        <a href="#constraints">Constraints</a>
        <a href="#safety">Safety &amp; Privacy</a>
        <a href="#acceptance">Acceptance Tests</a>
    </div>
</nav>

<div class="container">

<!-- 1. INTENT -->
<div class="section" id="intent">
    <div class="section-header">
        <span class="num">1</span>
        <h2>Intent &amp; Scope</h2>
    </div>
    <div class="section-body">
        <div class="two-col">
            <div>
                <span class="sub-label green">Goals</span>
                <ul class="goal-list">
                    <li>Interpret clinical lab reports (blood, urine, stool, standard tests) for <strong>educational insights only</strong></li>
                    <li>Structured output in Markdown + PDF with color-coded indicators (Red / Yellow / Green) and charts</li>
                    <li>Multi-language output: English + Urdu (v1); medical terms translated with English in parentheses</li>
                    <li>PII sanitization &mdash; all personal info scrubbed before LLM processing</li>
                    <li>Website upload (Next.js) and WhatsApp chat interface (Twilio)</li>
                    <li>Reference range sourcing (lab-provided &rarr; LLM medical knowledge fallback)</li>
                </ul>
            </div>
            <div>
                <span class="sub-label red">Non-Goals / Out of Scope</span>
                <ul class="non-goal-list">
                    <li>No medical diagnosis or treatment recommendation</li>
                    <li>No mobile app (v1)</li>
                    <li>No multi-language input reports (English only)</li>
                    <li>No EHR/EMR integration</li>
                    <li>No permanent data storage beyond retention period</li>
                    <li>No user accounts or authentication (v1)</li>
                    <li>No advanced analytics beyond WhatsApp trends</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 2. ARCHITECTURE -->
<div class="section" id="architecture">
    <div class="section-header">
        <span class="num">2</span>
        <h2>Architecture &amp; Tech Stack</h2>
    </div>
    <div class="section-body">

        <div class="callout info">
            <strong>Monorepo Structure</strong>
            Single repository with <code>/frontend</code> (Next.js) and <code>/backend</code> (FastAPI) directories. Docker Compose orchestrates all services.
        </div>

        <div class="arch-grid">
            <div class="arch-box fe">
                <h4>Frontend</h4>
                <ul>
                    <li>Next.js (React)</li>
                    <li>Upload form + results display</li>
                    <li>Google reCAPTCHA v3</li>
                    <li>Polling-based async UX</li>
                </ul>
            </div>
            <div class="arch-box be">
                <h4>Backend</h4>
                <ul>
                    <li>FastAPI (REST API)</li>
                    <li>Celery workers (async)</li>
                    <li>LangChain (LLM orchestration)</li>
                    <li>PaddleOCR / AWS Textract</li>
                    <li>WeasyPrint (PDF)</li>
                    <li>Matplotlib (charts)</li>
                </ul>
            </div>
            <div class="arch-box data">
                <h4>Data &amp; Infra</h4>
                <ul>
                    <li>MySQL (report records)</li>
                    <li>Redis (Celery broker + WhatsApp sessions)</li>
                    <li>Docker Compose</li>
                    <li>Docker Volume (file storage)</li>
                    <li>Twilio (WhatsApp)</li>
                </ul>
            </div>
        </div>

        <h3>Tech Stack</h3>
        <div class="tech-stack">
            <span class="tech-badge frontend">Next.js (React)</span>
            <span class="tech-badge backend">FastAPI</span>
            <span class="tech-badge backend">Celery</span>
            <span class="tech-badge ai">LangChain</span>
            <span class="tech-badge ai">OpenAI GPT-4o / GPT-4o-mini</span>
            <span class="tech-badge ai">PaddleOCR</span>
            <span class="tech-badge backend">WeasyPrint</span>
            <span class="tech-badge backend">Matplotlib</span>
            <span class="tech-badge storage">MySQL</span>
            <span class="tech-badge infra">Redis</span>
            <span class="tech-badge infra">Docker Compose</span>
            <span class="tech-badge infra">Twilio WhatsApp API</span>
            <span class="tech-badge frontend">reCAPTCHA v3</span>
        </div>

        <div class="callout warn" style="margin-top:20px">
            <strong>Key Decisions Made</strong>
            LangChain only (no LiteLLM). LLM models configurable via env vars &mdash; defaults: GPT-4o (analysis), GPT-4o-mini (pre-validation). MySQL for persistence, reports table only for v1; user management deferred.
        </div>
    </div>
</div>

<!-- 3. SUCCESS CRITERIA -->
<div class="section" id="success">
    <div class="section-header">
        <span class="num">3</span>
        <h2>Success Criteria</h2>
    </div>
    <div class="section-body">
        <div class="two-col">
            <div>
                <span class="sub-label green">Functional</span>
                <ul class="goal-list">
                    <li>Reports analyzed and returned in Markdown + PDF</li>
                    <li>Bar + gauge charts generated for abnormal/critical values</li>
                    <li>Reference ranges clearly identified with source noted</li>
                    <li>WhatsApp bot collects age/gender before processing</li>
                    <li>Detailed category-wise output sections</li>
                </ul>
            </div>
            <div>
                <span class="sub-label blue">Performance</span>
                <ul class="goal-list">
                    <li>Response time: 5&ndash;15 seconds per report</li>
                    <li>Handles concurrent uploads without failure</li>
                    <li>Polling-based async &mdash; instant job acknowledgment</li>
                </ul>
                <div style="margin-top:20px">
                    <span class="sub-label purple">Safety / Accuracy</span>
                    <ul class="goal-list">
                        <li>Mandatory disclaimers on all outputs</li>
                        <li>Color coding reflects LLM severity + rule-based mapping</li>
                        <li>Translation preserves medical terms in parentheses</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 4. INPUTS / OUTPUTS -->
<div class="section" id="io">
    <div class="section-header">
        <span class="num">4</span>
        <h2>Inputs / Outputs / Interfaces</h2>
    </div>
    <div class="section-body">
        <h3>API Inputs</h3>
        <table>
            <thead>
                <tr><th>Field</th><th>Type</th><th>Notes</th></tr>
            </thead>
            <tbody>
                <tr><td><code>user_id</code></td><td>string</td><td>Unique session identifier; tracks WhatsApp flow</td></tr>
                <tr><td><code>age</code></td><td>integer</td><td>Patient age; mandatory for WhatsApp, optional for website</td></tr>
                <tr><td><code>gender</code></td><td>string</td><td>Male / Female / Other; mandatory for WhatsApp, optional for website</td></tr>
                <tr><td><code>language</code></td><td>string</td><td>ISO code: <code>en</code> or <code>ur</code> (v1); defaults to <code>en</code></td></tr>
                <tr><td><code>file_b64</code></td><td>string</td><td>Base64-encoded report (PDF/JPG/PNG)</td></tr>
                <tr><td><code>file_type</code></td><td>string</td><td>MIME type: <code>application/pdf</code>, <code>image/jpeg</code>, <code>image/png</code></td></tr>
                <tr><td><code>captcha_token</code></td><td>string</td><td>Google reCAPTCHA v3 token (website only)</td></tr>
            </tbody>
        </table>

        <div class="divider"></div>

        <h3>Outputs</h3>
        <table>
            <thead>
                <tr><th>Output</th><th>Type</th><th>Notes</th></tr>
            </thead>
            <tbody>
                <tr><td>Markdown</td><td>string</td><td>Full interpretation with category-wise results, color indicators, associations</td></tr>
                <tr><td>PDF</td><td>file</td><td>Includes bar + gauge charts, color-coded values (WeasyPrint)</td></tr>
                <tr><td>Charts</td><td>image</td><td>Bar charts + gauge charts via Matplotlib, embedded in PDF</td></tr>
                <tr><td>Error</td><td>JSON</td><td>Standardized: <code>status</code>, <code>code</code>, <code>message</code></td></tr>
            </tbody>
        </table>

        <div class="divider"></div>

        <h3>Interfaces</h3>
        <table>
            <thead>
                <tr><th>Interface</th><th>Details</th></tr>
            </thead>
            <tbody>
                <tr><td><strong>API Endpoint</strong></td><td><code>POST /v1/analyze-report</code> &rarr; returns <code>job_id</code><br><code>GET /v1/status/{job_id}</code> &rarr; returns status + results when ready</td></tr>
                <tr><td><strong>Website</strong></td><td>Next.js upload form with age/gender inputs, reCAPTCHA v3, polling-based loading UX</td></tr>
                <tr><td><strong>WhatsApp</strong></td><td>Twilio WhatsApp Business API; sequential prompts (Age &rarr; Gender &rarr; Report); sends brief text + PDF</td></tr>
                <tr><td><strong>Storage</strong></td><td>Docker volume for uploaded files &amp; generated PDFs; auto-deleted after 24&ndash;48h</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- 5. WORKFLOW -->
<div class="section" id="workflow">
    <div class="section-header">
        <span class="num">5</span>
        <h2>Workflow / Logic</h2>
    </div>
    <div class="section-body">
        <div class="two-col">
            <div>
                <h3>Website Flow</h3>
                <div class="flow">
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div><div class="flow-connector"></div></div>
                        <div class="flow-content"><strong>Step 1 &mdash; Upload</strong><p>User enters age/gender (optional), selects file, reCAPTCHA v3 validates</p></div>
                    </div>
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div><div class="flow-connector"></div></div>
                        <div class="flow-content"><strong>Step 2 &mdash; Validate</strong><p>System checks file type, size (&le;20 MB), and page count (&le;30 pages)</p></div>
                    </div>
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div><div class="flow-connector"></div></div>
                        <div class="flow-content"><strong>Step 3 &mdash; Quick OCR</strong><p>PaddleOCR extracts text from uploaded file</p></div>
                    </div>
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div><div class="flow-connector"></div></div>
                        <div class="flow-content"><strong>Step 4 &mdash; Pre-Validate</strong><p>Cheap LLM (GPT-4o-mini) confirms extracted text is a lab report</p></div>
                    </div>
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div><div class="flow-connector"></div></div>
                        <div class="flow-content"><strong>Step 5 &mdash; PII Scrub</strong><p>Remove all personal info (name, ID, phone, address, DOB, doctor, hospital)</p></div>
                    </div>
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div><div class="flow-connector"></div></div>
                        <div class="flow-content"><strong>Step 6 &mdash; LLM Analysis</strong><p>LangChain &rarr; GPT-4o interprets in English, then translates to Urdu if requested</p></div>
                    </div>
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div><div class="flow-connector"></div></div>
                        <div class="flow-content"><strong>Step 7 &mdash; Charts</strong><p>Matplotlib generates bar + gauge charts for abnormal/critical values</p></div>
                    </div>
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div><div class="flow-connector"></div></div>
                        <div class="flow-content"><strong>Step 8 &mdash; Render</strong><p>Markdown displayed on page; PDF generated via WeasyPrint; available for download</p></div>
                    </div>
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div></div>
                        <div class="flow-content"><strong>Step 9 &mdash; Errors</strong><p>Handle invalid file, unreadable scan, unsupported lab type</p></div>
                    </div>
                </div>
            </div>
            <div>
                <h3>WhatsApp Flow (Twilio)</h3>
                <div class="flow">
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div><div class="flow-connector"></div></div>
                        <div class="flow-content"><strong>Step 1 &mdash; Collect Info</strong><p>Bot prompts sequentially: Age &rarr; Gender &rarr; Report upload</p></div>
                    </div>
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div><div class="flow-connector"></div></div>
                        <div class="flow-content"><strong>Step 2 &mdash; Validate + OCR</strong><p>File validated, OCR extracts text, cheap LLM confirms lab report</p></div>
                    </div>
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div><div class="flow-connector"></div></div>
                        <div class="flow-content"><strong>Step 3 &mdash; PII Scrub</strong><p>All personal info removed from OCR text</p></div>
                    </div>
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div><div class="flow-connector"></div></div>
                        <div class="flow-content"><strong>Step 4 &mdash; LLM Analysis</strong><p>LangChain processes and generates interpretation</p></div>
                    </div>
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div><div class="flow-connector"></div></div>
                        <div class="flow-content"><strong>Step 5 &mdash; PDF Generation</strong><p>PDF with charts generated via WeasyPrint + Matplotlib</p></div>
                    </div>
                    <div class="flow-step">
                        <div class="flow-line"><div class="flow-dot"></div></div>
                        <div class="flow-content"><strong>Step 6 &mdash; Deliver</strong><p>Bot sends brief text message ("Your report is ready") + PDF attachment</p></div>
                    </div>
                </div>

                <h3 style="margin-top:24px">Edge Cases</h3>
                <ul class="non-goal-list">
                    <li>Blurred/low-quality images &rarr; attempt OCR &rarr; reject if garbage text</li>
                    <li>Oversized/long reports &rarr; enforce file size + page limits</li>
                    <li>Non-English input reports &rarr; reject with message</li>
                    <li>LLM never gives diagnosis &rarr; disclaimers on all outputs</li>
                    <li>Incomplete WhatsApp sessions &rarr; Redis TTL auto-expires</li>
                </ul>
            </div>
        </div>

        <div class="callout info" style="margin-top: 16px">
            <strong>Async Processing (Website)</strong>
            <code>POST /v1/analyze-report</code> returns a <code>job_id</code> immediately. Frontend polls <code>GET /v1/status/{job_id}</code> every 2&ndash;3 seconds. A loading spinner with "Your report is being processed" is shown until results are available. Celery worker handles the actual processing.
        </div>
    </div>
</div>

<!-- 6. OUTPUT FORMAT -->
<div class="section" id="output-format">
    <div class="section-header">
        <span class="num">6</span>
        <h2>Output Format &amp; Visual Design</h2>
    </div>
    <div class="section-body">

        <h3>Interpretation Sections (ordered)</h3>
        <div class="output-preview">
            <div class="output-section"><span class="order">1</span><span class="name">Patient Info</span><span class="detail">Age, gender (if provided), report date</span></div>
            <div class="output-section"><span class="order">2</span><span class="name">Summary</span><span class="detail">High-level overview of findings</span></div>
            <div class="output-section"><span class="order">3</span><span class="name">Category-wise Results</span><span class="detail">CBC, Liver Panel, Kidney Panel, Thyroid, Lipid, etc.</span></div>
            <div class="output-section"><span class="order">4</span><span class="name">Abnormal Values Analysis</span><span class="detail">Detailed explanation of out-of-range values</span></div>
            <div class="output-section"><span class="order">5</span><span class="name">Clinical Associations</span><span class="detail">What abnormal patterns may indicate (educational)</span></div>
            <div class="output-section"><span class="order">6</span><span class="name">Lifestyle Tips</span><span class="detail">General wellness recommendations related to findings</span></div>
            <div class="output-section"><span class="order">7</span><span class="name">Disclaimer</span><span class="detail">Mandatory educational-only notice</span></div>
        </div>

        <div class="divider"></div>

        <h3>Color Coding System <span class="decision confirmed">CONFIRMED</span></h3>
        <p>LLM assigns severity categories per test value. System applies consistent color mapping:</p>
        <div class="color-demo">
            <span class="chip green-chip"><span class="dot"></span> Normal &mdash; Within reference range</span>
            <span class="chip yellow-chip"><span class="dot"></span> Borderline &mdash; Slightly outside range</span>
            <span class="chip red-chip"><span class="dot"></span> Critical &mdash; Significantly abnormal</span>
        </div>

        <div class="divider"></div>

        <h3>Charts (Matplotlib)</h3>
        <div class="two-col">
            <div>
                <span class="sub-label blue">Bar Charts</span>
                <p>Horizontal bar charts comparing each test value against its reference range. Color-coded bars (green/yellow/red) with reference range overlay.</p>
            </div>
            <div>
                <span class="sub-label purple">Gauge Charts</span>
                <p>Speedometer-style gauge charts for individual critical/abnormal values showing where the patient's value falls within the overall range.</p>
            </div>
        </div>

        <div class="divider"></div>

        <h3>Reference Ranges <span class="decision confirmed">CONFIRMED</span></h3>
        <div class="callout success">
            <strong>Strategy</strong>
            LLM extracts reference ranges from the lab report itself. If ranges are not printed on the report, the LLM uses its medical knowledge &mdash; and the output <strong>explicitly states</strong>: "Reference values not available in the report; ranges based on standard medical knowledge."
        </div>

        <div class="divider"></div>

        <h3>Translation (v1) <span class="decision confirmed">CONFIRMED</span></h3>
        <p><strong>Languages:</strong> English + Urdu only</p>
        <p><strong>Medical terms:</strong> Translated to target language with English in parentheses.</p>
        <div class="callout info">
            <strong>Example (Urdu)</strong>
            &#x622;&#x67E; &#x6A9;&#x627; &#x6C1;&#x6CC;&#x645;&#x648;&#x6AF;&#x644;&#x648;&#x628;&#x646; (Hemoglobin) &#x644;&#x6CC;&#x648;&#x644; &#x646;&#x627;&#x631;&#x645;&#x644; &#x6C1;&#x6D2;&#x6D4; &#x633;&#x641;&#x6CC;&#x62F; &#x62E;&#x648;&#x646; &#x6A9;&#x6D2; &#x62E;&#x644;&#x6CC;&#x6D2; (WBC) &#x6A9;&#x6CC; &#x62A;&#x639;&#x62F;&#x627;&#x62F; &#x632;&#x6CC;&#x627;&#x62F;&#x6C1; &#x6C1;&#x6D2;&#x6D4;
        </div>
    </div>
</div>

<!-- 7. CONFIGURATION -->
<div class="section" id="config">
    <div class="section-header">
        <span class="num">7</span>
        <h2>Configuration Options</h2>
    </div>
    <div class="section-body">
        <p>All options configurable via environment variables.</p>
        <div class="config-grid">
            <div class="config-item">
                <div class="key">MAX_FILE_SIZE</div>
                <div class="val">Default: <strong>20 MB</strong></div>
                <div class="desc">Maximum upload file size limit</div>
            </div>
            <div class="config-item">
                <div class="key">MAX_PAGES</div>
                <div class="val">Default: <strong>30</strong></div>
                <div class="desc">Maximum page count per report</div>
            </div>
            <div class="config-item">
                <div class="key">RETENTION_PERIOD</div>
                <div class="val">Default: <strong>24&ndash;48 hours</strong></div>
                <div class="desc">Auto-deletion of stored files</div>
            </div>
            <div class="config-item">
                <div class="key">VALIDATION_THRESHOLD</div>
                <div class="val">Default: <strong>0.8</strong></div>
                <div class="desc">Cheap LLM confidence threshold for lab report validation</div>
            </div>
            <div class="config-item">
                <div class="key">LLM_ANALYSIS_MODEL</div>
                <div class="val">Default: <strong>gpt-4o</strong></div>
                <div class="desc">Primary LLM model for report analysis</div>
            </div>
            <div class="config-item">
                <div class="key">LLM_VALIDATION_MODEL</div>
                <div class="val">Default: <strong>gpt-4o-mini</strong></div>
                <div class="desc">Cheap LLM for pre-validation step</div>
            </div>
            <div class="config-item">
                <div class="key">LLM_API_KEY</div>
                <div class="val">Default: <strong>(required)</strong></div>
                <div class="desc">OpenAI API key (or other provider key)</div>
            </div>
            <div class="config-item">
                <div class="key">OCR_ENGINE</div>
                <div class="val">Default: <strong>PaddleOCR</strong></div>
                <div class="desc">OCR engine; alternative: aws_textract</div>
            </div>
            <div class="config-item">
                <div class="key">RATE_LIMIT_PER_IP</div>
                <div class="val">Default: <strong>10 / hour</strong></div>
                <div class="desc">Maximum report submissions per IP per hour</div>
            </div>
            <div class="config-item">
                <div class="key">RECAPTCHA_SECRET_KEY</div>
                <div class="val">Default: <strong>(required)</strong></div>
                <div class="desc">Google reCAPTCHA v3 server-side secret key</div>
            </div>
            <div class="config-item">
                <div class="key">TWILIO_ACCOUNT_SID</div>
                <div class="val">Default: <strong>(required for WhatsApp)</strong></div>
                <div class="desc">Twilio account credentials for WhatsApp integration</div>
            </div>
            <div class="config-item">
                <div class="key">MYSQL_URL</div>
                <div class="val">Default: <strong>mysql://localhost:3306/labreportai</strong></div>
                <div class="desc">MySQL connection string for report persistence</div>
            </div>
        </div>
    </div>
</div>

<!-- 8. CONSTRAINTS -->
<div class="section" id="constraints">
    <div class="section-header">
        <span class="num">8</span>
        <h2>Constraints</h2>
    </div>
    <div class="section-body">
        <table>
            <thead>
                <tr><th>Category</th><th>Constraint</th></tr>
            </thead>
            <tbody>
                <tr><td><strong>Stack</strong></td><td>FastAPI, Celery+Redis, PaddleOCR (or Textract), WeasyPrint, LangChain, Matplotlib, Next.js, MySQL</td></tr>
                <tr><td><strong>Performance</strong></td><td>5&ndash;15 second response time per report</td></tr>
                <tr><td><strong>Security</strong></td><td>HTTPS required; Google reCAPTCHA v3 for website; per-IP rate limiting</td></tr>
                <tr><td><strong>Auth</strong></td><td>No user auth for v1; reCAPTCHA only. No API key auth for end users.</td></tr>
                <tr><td><strong>Language</strong></td><td>English-only input reports; output in English or Urdu (v1)</td></tr>
                <tr><td><strong>Medical</strong></td><td>No diagnosis or treatment recommendations &mdash; educational only</td></tr>
                <tr><td><strong>Charts</strong></td><td>Bar + gauge charts from LLM structured JSON, embedded in PDF</td></tr>
                <tr><td><strong>Deployment</strong></td><td>Docker Compose; file storage via Docker volume</td></tr>
                <tr><td><strong>Data</strong></td><td>MySQL for report records; Redis for Celery + WhatsApp sessions; temporary file storage (24&ndash;48h)</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- 9. SAFETY -->
<div class="section" id="safety">
    <div class="section-header">
        <span class="num">9</span>
        <h2>Safety, Security &amp; Privacy</h2>
    </div>
    <div class="section-body">

        <h3>PII Sanitization <span class="decision confirmed">CONFIRMED</span></h3>
        <p>All personal information is scrubbed from OCR-extracted text <strong>before</strong> sending to the LLM:</p>
        <table>
            <thead>
                <tr><th>PII Type</th><th>Action</th></tr>
            </thead>
            <tbody>
                <tr><td>Patient Name</td><td>Removed / replaced with placeholder</td></tr>
                <tr><td>Patient ID / MRN</td><td>Removed</td></tr>
                <tr><td>Phone Number</td><td>Removed</td></tr>
                <tr><td>Address</td><td>Removed</td></tr>
                <tr><td>Date of Birth</td><td>Removed (age is passed separately)</td></tr>
                <tr><td>Doctor Name</td><td>Removed</td></tr>
                <tr><td>Hospital / Lab Name</td><td>Removed</td></tr>
            </tbody>
        </table>

        <div class="divider"></div>

        <h3>Security Measures</h3>
        <ul class="goal-list">
            <li>HTTPS required for all communications</li>
            <li>Google reCAPTCHA v3 (invisible) on website uploads</li>
            <li>Per-IP rate limiting (default: 10 requests/hour)</li>
            <li>Temporary file storage with 24&ndash;48h auto-deletion</li>
            <li>No permanent storage of uploaded lab reports</li>
        </ul>

        <div class="divider"></div>

        <h3>Mandatory Disclaimer</h3>
        <div class="disclaimer-box">
            <div class="icon">&#9888;</div>
            <blockquote>
                "This report provides educational insights and clinical associations only. It is not a diagnosis or treatment recommendation. Please consult a qualified physician."
            </blockquote>
        </div>
    </div>
</div>

<!-- 10. ACCEPTANCE -->
<div class="section" id="acceptance">
    <div class="section-header">
        <span class="num">10</span>
        <h2>Acceptance Criteria / Test Scenarios</h2>
    </div>
    <div class="section-body">
        <ul class="checklist">
            <li><span class="check"></span>Upload PDF/JPG/PNG &rarr; validated &rarr; OCR &rarr; LLM analysis &rarr; Markdown + PDF returned</li>
            <li><span class="check"></span>WhatsApp flow: sequential Age / Gender / Report capture works correctly via Twilio</li>
            <li><span class="check"></span>WhatsApp delivers brief text message + PDF attachment (no raw markdown)</li>
            <li><span class="check"></span>Blurred / low-quality images rejected with re-upload message</li>
            <li><span class="check"></span>Unsupported lab type rejected with informative error message</li>
            <li><span class="check"></span>Urdu translation preserves medical terms in parentheses</li>
            <li><span class="check"></span>Bar + gauge charts accurately reflect abnormal/critical values in PDF</li>
            <li><span class="check"></span>All configuration options applied correctly (file size, pages, LLM model, OCR engine)</li>
            <li><span class="check"></span>Reference range sources displayed; fallback note shown when ranges not on report</li>
            <li><span class="check"></span>Disclaimers present on all Markdown and PDF outputs</li>
            <li><span class="check"></span>reCAPTCHA v3 blocks bot submissions on website</li>
            <li><span class="check"></span>Per-IP rate limiting enforced (10/hour default)</li>
            <li><span class="check"></span>PII fully scrubbed &mdash; no personal info reaches the LLM</li>
            <li><span class="check"></span>Files auto-deleted after retention period (24&ndash;48h)</li>
            <li><span class="check"></span>Polling endpoint returns correct status transitions: pending &rarr; processing &rarr; completed/failed</li>
            <li><span class="check"></span>Docker Compose brings up all services (FastAPI, Celery, Redis, MySQL, Next.js)</li>
        </ul>
    </div>
</div>

</div><!-- container -->

<div class="footer">
    Lab Report AI &middot; Specification v2.1 &middot; Updated with Q&amp;A Decisions &middot; For Development Reference Only
</div>

</body>
</html>
