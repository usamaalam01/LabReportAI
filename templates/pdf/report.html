<!DOCTYPE html>
<html lang="{{ 'ur' if is_rtl else 'en' }}" dir="{{ 'rtl' if is_rtl else 'ltr' }}">
<head>
    <meta charset="UTF-8">
    <title>{% if is_rtl %}لیب رپورٹ AI - تجزیہ رپورٹ{% else %}Lab Report AI - Analysis Report{% endif %}</title>
    <style>
        {{ css_content | safe }}
    </style>
</head>
<body>

    <!-- Title -->
    <h1 class="report-title">{% if is_rtl %}لیب رپورٹ تجزیہ{% else %}Lab Report Analysis{% endif %}</h1>

    <!-- Patient Information -->
    <section class="patient-info">
        <h2>{% if is_rtl %}مریض کی معلومات{% else %}Patient Information{% endif %}</h2>
        <div class="info-grid">
            {% if analysis.patient_info.name %}
            <div class="info-item">
                <span class="info-label">{% if is_rtl %}نام:{% else %}Name:{% endif %}</span>
                <span class="info-value">{{ analysis.patient_info.name }}</span>
            </div>
            {% endif %}

            {% if analysis.patient_info.age %}
            <div class="info-item">
                <span class="info-label">{% if is_rtl %}عمر:{% else %}Age:{% endif %}</span>
                <span class="info-value">{{ analysis.patient_info.age }}</span>
            </div>
            {% endif %}

            {% if analysis.patient_info.gender %}
            <div class="info-item">
                <span class="info-label">{% if is_rtl %}جنس:{% else %}Gender:{% endif %}</span>
                <span class="info-value">{{ analysis.patient_info.gender }}</span>
            </div>
            {% endif %}

            {% if analysis.patient_info.date_of_birth %}
            <div class="info-item">
                <span class="info-label">{% if is_rtl %}تاریخ پیدائش:{% else %}Date of Birth:{% endif %}</span>
                <span class="info-value">{{ analysis.patient_info.date_of_birth }}</span>
            </div>
            {% endif %}

            {% if analysis.patient_info.report_date %}
            <div class="info-item">
                <span class="info-label">{% if is_rtl %}رپورٹ کی تاریخ:{% else %}Report Date:{% endif %}</span>
                <span class="info-value">{{ analysis.patient_info.report_date }}</span>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Summary -->
    <section class="summary">
        <h2>{% if is_rtl %}خلاصہ{% else %}Summary{% endif %}</h2>
        <p>{{ analysis.summary or ('خلاصہ دستیاب نہیں ہے۔' if is_rtl else 'No summary available.') }}</p>
    </section>

    <!-- Test Results -->
    <section class="test-results">
        <h2>{% if is_rtl %}ٹیسٹ کے نتائج{% else %}Test Results{% endif %}</h2>

        {% for category in analysis.categories %}
        <div class="category-block">
            <h3>{{ category.name }}</h3>

            {% if category.tests %}
            <table class="results-table">
                <thead>
                    <tr>
                        {% if is_rtl %}
                        <th class="col-status">حالت</th>
                        <th class="col-test">ٹیسٹ</th>
                        <th class="col-value">قدر</th>
                        <th class="col-unit">اکائی</th>
                        <th class="col-ref">حوالہ حد</th>
                        <th class="col-interp">تشریح</th>
                        {% else %}
                        <th class="col-status">Status</th>
                        <th class="col-test">Test</th>
                        <th class="col-value">Value</th>
                        <th class="col-unit">Unit</th>
                        <th class="col-ref">Reference Range</th>
                        <th class="col-interp">Interpretation</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for test in category.tests %}
                    <tr class="severity-{{ test.severity }}">
                        <td class="col-status">
                            <span class="severity-dot severity-{{ test.severity }}">&#9679;</span>
                        </td>
                        <td class="col-test">{{ test.test_name }}</td>
                        <td class="col-value">{{ test.value }}</td>
                        <td class="col-unit">{{ test.unit or '' }}</td>
                        <td class="col-ref">
                            {{ test.reference_range or 'N/A' }}
                            {% if test.reference_source == 'standard_knowledge' %}
                            <span class="ref-note">*</span>
                            {% endif %}
                        </td>
                        <td class="col-interp">{{ test.interpretation or '' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% set has_standard = [] %}
            {% for test in category.tests %}
                {% if test.reference_source == 'standard_knowledge' %}
                    {% if has_standard.append(1) %}{% endif %}
                {% endif %}
            {% endfor %}
            {% if has_standard %}
            <p class="ref-footnote">
                {% if is_rtl %}
                * حوالہ اقدار رپورٹ میں دستیاب نہیں ہیں؛ حدود معیاری طبی معلومات پر مبنی ہیں۔
                {% else %}
                * Reference values not available in the report; ranges based on standard medical knowledge.
                {% endif %}
            </p>
            {% endif %}

            <!-- Charts for this category -->
            {% set cat_idx = loop.index0 %}
            {% if charts.get(cat_idx) %}
                {% if charts[cat_idx].bar %}
                <div class="chart-container">
                    <img src="file://{{ charts[cat_idx].bar }}" class="chart-bar" alt="Bar chart for {{ category.name }}">
                </div>
                {% endif %}

                {% if charts[cat_idx].gauges %}
                <div class="gauge-container">
                    {% for gauge_path in charts[cat_idx].gauges %}
                    <img src="file://{{ gauge_path }}" class="chart-gauge" alt="Gauge chart">
                    {% endfor %}
                </div>
                {% endif %}
            {% endif %}

            {% else %}
            <p class="no-tests">{% if is_rtl %}اس زمرے میں کوئی ٹیسٹ نہیں۔{% else %}No tests in this category.{% endif %}</p>
            {% endif %}
        </div>
        {% endfor %}
    </section>

    <!-- Abnormal Value Analysis -->
    {% if analysis.abnormal_analysis %}
    <section class="abnormal-analysis">
        <h2>{% if is_rtl %}غیر معمولی اقدار کا تجزیہ{% else %}Abnormal Value Analysis{% endif %}</h2>
        <p>{{ analysis.abnormal_analysis }}</p>
    </section>
    {% endif %}

    <!-- Clinical Associations -->
    {% if analysis.clinical_associations %}
    <section class="clinical-associations">
        <h2>{% if is_rtl %}طبی وابستگیاں{% else %}Clinical Associations{% endif %}</h2>
        <p>{{ analysis.clinical_associations }}</p>
    </section>
    {% endif %}

    <!-- Lifestyle Recommendations -->
    {% if analysis.lifestyle_tips %}
    <section class="lifestyle-tips">
        <h2>{% if is_rtl %}طرزِ زندگی کی سفارشات{% else %}Lifestyle Recommendations{% endif %}</h2>
        <p>{{ analysis.lifestyle_tips }}</p>
    </section>
    {% endif %}

    <!-- Disclaimer -->
    <section class="disclaimer">
        <div class="disclaimer-box">
            <strong>{% if is_rtl %}اعلان دستبرداری:{% else %}Disclaimer:{% endif %}</strong> {{ disclaimer }}
        </div>
    </section>

</body>
</html>
